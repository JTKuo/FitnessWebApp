<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人化健身暨健康追蹤</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Ionicons 圖示庫 -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <!-- 引入 Google Fonts: Exo 2 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- 引入 d3 JS 函式庫 -->
    <script src="https://d3js.org/d3.v7.min.js"></script> 
    <!-- 引入 Chart.js 函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- 引入 Cal-Heatmap 的 CSS 跟 JS 函式庫 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.3/dist/cal-heatmap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.3/dist/cal-heatmap.min.js"></script>
    <!-- 引入 ImageCompression.js 函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <!-- 引入 Sortable.js 函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        /* --- 工業風格 UI 定制 (黃/黑/灰棕) --- */
        :root {
            --color-yellow: #ffc300;
            --color-dark-brown: #2d2a27;
            --color-black: #000000;
        }
        body {
            -webkit-tap-highlight-color: transparent;
            font-family: 'Exo 2', sans-serif;
            background-color: var(--color-black);
        }
        .main-container {
            background-color: var(--color-dark-brown);
            background-image:
                linear-gradient(rgba(255, 195, 0, 0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 195, 0, 0.07) 1px, transparent 1px);
            background-size: 2.5rem 2.5rem;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 載入動畫 */
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .loader-ring {
            position: absolute;
            border: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1.5s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }
        .loader-ring:nth-child(1) {
            width: 120px;
            height: 120px;
            border-top-color: var(--color-yellow);
        }
        .loader-ring:nth-child(2) {
            width: 100px;
            height: 100px;
            border-bottom-color: #ffffff;
            animation-delay: -0.2s;
        }
         .loader-ring:nth-child(3) {
            width: 80px;
            height: 80px;
            border-left-color: var(--color-yellow);
            animation-delay: -0.4s;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* --- 動畫效果 --- */
        .animated-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .fade-in {
            opacity: 0;
            transform: scale(0.95);
        }
        .is-visible {
            opacity: 1;
            transform: scale(1);
        }
        /* 按鈕輝光效果 */
        .btn-glow {
            box-shadow: 0 0 8px rgba(255, 195, 0, 0.6), 0 0 12px rgba(255, 195, 0, 0.4);
        }
        .btn-glow:hover {
            box-shadow: 0 0 18px rgba(255, 195, 0, 0.8), 0 0 30px rgba(255, 195, 0, 0.6);
        }
        /* 卡片/容器樣式 */
        .card {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 195, 0, 0.3);
            backdrop-filter: blur(5px);
        }
        /* 輸入框樣式 */
        input, select, textarea {
            background-color: var(--color-black);
            border: 1px solid var(--color-yellow);
            color: #e0e6e9;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(255, 195, 0, 0.7);
        }
        /* --- Toast 通知樣式 --- */
        #toast-notification {
            /* ✅ 1. 限制最大寬度，確保內容會自動換行 */
            max-width: 90%; 
            /* ✅ 2. 增加更深的陰影，營造立體感 */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);
            /* ✅ 3. 加上細微邊框，增加與背景的區隔 */
            border: 1px solid rgba(255, 255, 255, 0.1);
            
            animation-duration: 0.5s;
            animation-fill-mode: both;
        }
        #toast-notification.toast-in {
            animation-name: toast-in;
        }
        #toast-notification.toast-out {
            animation-name: toast-out;
        }
        @keyframes toast-in {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        @keyframes toast-out {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -20px); }
        }

        /* --- 拖曳時的游標和卡片樣式 --- */
        .js-drag-handle:active,
        .js-pr-drag-handle:active {
            cursor: grabbing;
        }        
        .sortable-ghost {
            opacity: 0.4;
            background: #4a4642; /* 拖曳佔位符的背景色 */
        }
        .sortable-chosen {
            cursor: grabbing; 
            transform: scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        /* 彈出視窗樣式 */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        .modal {
            animation: modal-pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modal-pop-in {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        /* 用於個人資料顯示的樣式 */
        .view-mode {
            min-height: 42px; /* 與輸入框高度保持一致 */
        }
        
        /* 客製化日期選擇器圖示 */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(0.8) sepia(1) hue-rotate(10deg) saturate(1000%);
            cursor: pointer;
            font-size: 1.2em;
        }

        /* --- 新成就 PR 特效 --- */
        .new-pr-badge, .new-pr-crown {
            display: none; /* 預設隱藏 */
            position: absolute;
        }
        /* 當卡片有 .is-new-pr 這個 class 時，才顯示特效 */
        .is-new-pr .new-pr-badge,
        .is-new-pr .new-pr-crown {
            display: block;
        }
        /* 卡片本體增加輝光效果 */
        .is-new-pr {
            position: relative; /* 讓絕對定位的子元素有參考點 */
            box-shadow: 0 0 15px rgba(255, 195, 0, 0.8), 0 0 25px rgba(255, 195, 0, 0.6);
            border-color: rgba(255, 195, 0, 0.7);
        }
        /* "NEW" 徽章的樣式 */
        .new-pr-badge {
            top: -10px;
            right: -10px;
            background-color: #ffc300;
            color: #000;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 9999px;
            animation: pulse 1.5s infinite;
        }
        /* 皇冠圖示的樣式 */
        .new-pr-crown {
            top: -12px;
            left: -8px;
            color: #ffc300;
            font-size: 1.8rem;
            transform: rotate(-15deg);
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
        }
        @keyframes pulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.1); }
        }

        /* 成就頁面編輯模式的樣式 */
        .pr-card.is-editable {
            cursor: grab;
            border: 1px dashed rgba(255, 195, 0, 0.5);
        }
        .pr-card.is-editable:hover {
            background-color: rgba(255, 195, 0, 0.1);
        }

        /* 圖片 Modal 的樣式 */
        #image-modal-close {
            transition: transform 0.2s ease;
        }
        #image-modal-close:hover {
            transform: scale(1.1);
        }

        /* 成就頁面分類標題的樣式 */
        .category-title {
            border-left: 4px solid var(--color-yellow);
            padding-left: 0.75rem;
        }

        #heatmap-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 0.5rem; /* 在四周都留下一點邊距 */
            box-sizing: border-box;
            min-height: 170px; /* 給一個最小高度避免無數據時塌陷 */
        }

        #heatmap-container svg.cal-heatmap-container {
            width: 100% !important;
            height: auto !important;
            overflow: visible !important;
        }
    </style>
</head>
<body class="text-white font-sans antialiased">
    <div id="toast-notification" class="hidden fixed top-5 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-lg text-white font-semibold shadow-lg text-center">
        <span id="toast-message"></span>
    </div>

    <!-- 全螢幕載入遮罩 -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-90 flex justify-center items-center z-50">
        <div class="loader-container">
            <div class="loader-ring"></div>
            <div class="loader-ring"></div>
            <div class="loader-ring"></div>
        </div>
    </div>

    <!-- 新增/儲存 Modal -->
    <div id="prompt-modal" class="hidden fixed inset-0 z-40 flex justify-center items-center p-4">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="modal card rounded-lg p-6 w-full max-w-sm relative">
            <h3 id="prompt-title" class="text-xl font-bold text-yellow-400 mb-4 text-center"></h3>
            <input type="text" id="prompt-input" class="w-full rounded-md p-3 text-lg text-center">
            <div class="grid grid-cols-2 gap-4 mt-4">
                <button id="prompt-cancel" class="w-full bg-[#2d2a27] hover:bg-black border border-gray-600 p-3 rounded-md font-semibold">取消</button>
                <button id="prompt-confirm" class="w-full bg-yellow-500 hover:bg-yellow-600 border border-yellow-400 text-black p-3 rounded-md font-semibold btn-glow">確認</button>
            </div>
        </div>
    </div>

    <!-- 載入範本 Modal -->
    <div id="load-template-modal" class="hidden fixed inset-0 z-40 flex justify-center items-center p-4">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="modal card rounded-lg p-6 w-full max-w-sm relative">
            <h3 class="text-xl font-bold text-yellow-400 mb-4 text-center">載入訓練範本</h3>
            <div id="template-list" class="space-y-2 max-h-60 overflow-y-auto">
                <!-- 範本列表將由 JS 動態填入 -->
            </div>
             <button id="load-template-cancel" class="mt-4 w-full bg-[#2d2a27] hover:bg-black border border-gray-600 p-3 rounded-md font-semibold">取消</button>
        </div>
    </div>

    <!-- 確認刪除 Modal -->
    <div id="confirm-delete-modal" class="hidden fixed inset-0 z-40 flex justify-center items-center p-4">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="modal card rounded-lg p-6 w-full max-w-sm relative">
            <h3 class="text-xl font-bold text-yellow-400 mb-2 text-center">確認刪除</h3>
            <p id="delete-confirm-message" class="text-center text-gray-300 mb-4">您確定要刪除這個項目嗎？</p>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <button id="cancel-delete" class="w-full bg-[#2d2a27] hover:bg-black border border-gray-600 p-3 rounded-md font-semibold">取消</button>
                <button id="confirm-delete" class="w-full bg-red-600 hover:bg-red-700 border border-red-500 text-white p-3 rounded-md font-semibold">確認刪除</button>
            </div>
        </div>
    </div>

    <!-- 對比 Modal -->
    <div id="compare-photos-modal" class="hidden fixed inset-0 z-40 flex justify-center items-center p-4">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="modal card rounded-lg p-6 w-full max-w-3xl relative max-h-[90vh] flex flex-col">
            <h3 class="text-xl font-bold text-yellow-400 mb-4 text-center">歷史體態對比</h3>

            <div class="flex-grow grid grid-cols-2 gap-4 overflow-y-auto">
                <div class="space-y-3">
                    <select id="compare-select-before" class="w-full rounded-md p-2">
                        <option value="">選擇對比日期 (之前)</option>
                    </select>
                    <div id="compare-front-before" class="bg-black/30 aspect-square flex items-center justify-center rounded text-gray-500">正面</div>
                    <div id="compare-side-before" class="bg-black/30 aspect-square flex items-center justify-center rounded text-gray-500">側面</div>
                    <div id="compare-back-before" class="bg-black/30 aspect-square flex items-center justify-center rounded text-gray-500">背面</div>
                </div>
                <div class="space-y-3">
                    <select id="compare-select-after" class="w-full rounded-md p-2">
                        <option value="">選擇對比日期 (之後)</option>
                    </select>
                    <div id="compare-front-after" class="bg-black/30 aspect-square flex items-center justify-center rounded text-gray-500">正面</div>
                    <div id="compare-side-after" class="bg-black/30 aspect-square flex items-center justify-center rounded text-gray-500">側面</div>
                    <div id="compare-back-after" class="bg-black/30 aspect-square flex items-center justify-center rounded text-gray-500">背面</div>
                </div>
            </div>

            <button id="compare-modal-close" class="mt-4 w-full bg-[#2d2a27] hover:bg-black border border-gray-600 p-3 rounded-md font-semibold">關閉</button>
        </div>
    </div>

    <!-- 新增動作 Modal -->
	  <div id="autocomplete-modal" class="hidden fixed inset-0 z-40 flex justify-center items-start pt-20 p-4">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="modal card rounded-lg p-6 w-full max-w-sm relative">
            <h3 id="autocomplete-title" class="text-xl font-bold text-yellow-400 mb-4 text-center">新增訓練動作</h3>
            <input type="text" id="autocomplete-input" class="w-full rounded-md p-3 text-lg" placeholder="請輸入動作名稱...">
            
            <div id="suggestions-list" class="mt-2 max-h-48 overflow-y-auto space-y-1">
                </div>

            <div class="grid grid-cols-2 gap-4 mt-4">
                <button id="autocomplete-cancel" class="w-full bg-[#2d2a27] hover:bg-black border border-gray-600 p-3 rounded-md font-semibold">取消</button>
                <button id="autocomplete-confirm" class="w-full bg-yellow-500 hover:bg-yellow-600 border border-yellow-400 text-black p-3 rounded-md font-semibold btn-glow">確認</button>
            </div>
        </div>
    </div>

    <!-- 圖片點擊放大 Modal -->
    <div id="image-modal" class="hidden fixed inset-0 z-50 flex justify-center items-center p-4">
        <div id="image-modal-backdrop" class="modal-backdrop absolute inset-0"></div>
        <div class="relative z-10 w-full h-full flex items-center justify-center">
            <img id="modal-image" src="" class="max-w-[95vw] max-h-[90vh] object-contain rounded-lg shadow-2xl" alt="放大圖片預覽">
            <button id="image-modal-close" class="absolute top-0 right-0 m-4 text-white text-4xl bg-black/50 rounded-full leading-none w-10 h-10 flex items-center justify-center">
                &times;
            </button>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="container mx-auto max-w-lg min-h-screen flex flex-col pb-20 main-container border-x border-yellow-700/30">

        <!-- 管理者頂部欄 (預設隱藏) -->
        <div id="admin-bar" class="hidden sticky top-0 bg-yellow-500 text-black p-2 z-30 border-b border-yellow-300 backdrop-filter backdrop-blur-sm">
            <label for="user-switcher" class="block text-sm font-bold mb-1 text-black/80">管理者模式</label>
            <select id="user-switcher" class="w-full bg-yellow-400 text-black border border-yellow-600 rounded-md p-1 text-sm focus:ring-2 focus:ring-yellow-200">
                <!-- 使用者列表將由 JS 動態填入 -->
            </select>
        </div>

        <!-- 主要內容區域 -->
        <main class="flex-grow p-4">

            <!-- ==== 主畫面 (Dashboard) ==== -->
            <div id="page-dashboard" class="page active">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-yellow-400 drop-shadow-[0_0_5px_rgba(255,195,0,0.5)]">身分驗證成功</h1>
                    <p id="welcome-message" class="text-gray-400">系統待命中...</p>
                </div>
                
                <!-- 每月提醒橫幅 (預設隱藏) -->
                <div id="reminder-banner" class="hidden card p-4 rounded-lg mb-6 text-center border-yellow-400/50">
                    <p class="font-semibold text-lg text-yellow-400">重要通知：</p>
                    <p class="text-base text-gray-300">建議更新本月體態數據。</p>
                </div>

                <!-- 個人資料區塊 -->
                <div id="profile-section" class="mt-8 space-y-4">
                    <div id="card-basic-info" class="card p-4 rounded-lg space-y-4">
                        <div class="flex justify-between items-center border-b border-yellow-500/30 pb-2">
                            <h3 class="text-lg font-semibold text-yellow-500">
                               <ion-icon name="person-outline" class="mr-2"></ion-icon>
                               個人基本資訊
                            </h3>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">姓名 / 暱稱</label>
                            <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="未設定">未設定</p>
                            <input data-key="name" type="text" placeholder="方便管理的稱呼" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">年齡</label>
                                <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="未設定">未設定</p>
                                <input data-key="age" type="number" min="0" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">性別</label>
                                <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="未設定">未設定</p>
                                <select data-key="gender" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                                    <option value="male">男性</option>
                                    <option value="female">女性</option>
                                </select>
                            </div>
                        </div>
                         <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">身高 (cm)</label>
                                <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="未設定">未設定</p>
                                <input data-key="height" type="number" min="0" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">體重 (kg)</label>
                                <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="未設定">未設定</p>
                                <input data-key="weight" type="number" min="0" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                            </div>
                        </div>
                        <div>
                             <label class="block text-sm font-medium text-gray-300 mb-1">體脂率 (%)</label>
                             <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="未設定">未設定</p>
                             <input data-key="bodyfat" type="number" min="0" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                        </div>

                        <!-- InBody 數據區塊 -->
                        <div class="pt-4 border-t border-yellow-500/30 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">學員 CID</label>
                                <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="未設定">未設定</p>
                                <input data-key="cid" type="text" placeholder="Client ID" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">InBody 分數</label>
                                    <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="--">--</p>
                                    <input data-key="inbody_score" type="number" min="0" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">骨骼肌重 (kg)</label>
                                    <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="--">--</p>
                                    <input data-key="smm" type="number" min="0" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">體脂肪重 (kg)</label>
                                    <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="--">--</p>
                                    <input data-key="bfm" type="number" min="0" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">BMI</label>
                                    <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="--">--</p>
                                    <input data-key="bmi" type="number" min="0" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">內臟脂肪等級</label>
                                    <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="--">--</p>
                                    <input data-key="vfl" type="number" min="0" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 健康狀況卡片 -->
                    <div id="card-health-status" class="card p-4 rounded-lg space-y-4">
                        <div class="flex justify-between items-center border-b border-yellow-500/30 pb-2">
                            <h3 class="text-lg font-semibold text-yellow-500">
                                <ion-icon name="pulse-outline" class="mr-2"></ion-icon>
                                健康狀況
                            </h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">運動經驗</label>
                                <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="未設定">未設定</p>
                                <select data-key="experience" class="edit-mode hidden w-full rounded-md p-2">
                                    <option>初學者 (1年以下)</option>
                                    <option>中階 (1-3年)</option>
                                    <option>高階 (3年以上)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">生活型態</label>
                                <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="未設定">未設定</p>
                                <select data-key="lifestyle" class="edit-mode hidden w-full rounded-md p-2">
                                    <option>久坐</option>
                                    <option>體力消耗大</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">過往病史或傷病</label>
                            <!-- 加入 whitespace-pre-wrap class -->
                            <p class="view-mode whitespace-pre-wrap w-full rounded-md p-2 bg-black/30" data-placeholder="無">無</p>
                            <textarea data-key="history" rows="3" placeholder="心臟病、高血壓、關節受傷等" class="edit-mode hidden w-full rounded-md p-2"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">靜態評估</label>
                            <!-- 加入 whitespace-pre-wrap class -->
                            <p class="view-mode whitespace-pre-wrap w-full rounded-md p-2 bg-black/30" data-placeholder="無">無</p>
                            <textarea data-key="static_assessment" rows="3" placeholder="記錄靜態姿勢評估的結果" class="edit-mode hidden w-full rounded-md p-2"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">動態評估</label>
                            <!-- 加入 whitespace-pre-wrap class -->
                            <p class="view-mode whitespace-pre-wrap w-full rounded-md p-2 bg-black/30" data-placeholder="無">無</p>
                            <textarea data-key="dynamic_assessment" rows="3" placeholder="記錄動態動作評估的結果" class="edit-mode hidden w-full rounded-md p-2"></textarea>
                        </div>
                    </div>

                    <!-- 個人化建議卡片 -->
                    <div id="card-recommendations" class="card p-4 rounded-lg space-y-4">
                        <div class="flex justify-between items-center border-b border-yellow-500/30 pb-2">
                            <h3 class="text-lg font-semibold text-yellow-500">
                                <ion-icon name="bulb-outline" class="mr-2"></ion-icon>
                                個人化建議
                            </h3>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">每周運動頻率</label>
                            <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="未設定">未設定</p>
                            <select data-key="frequency" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                                <option value="1.2">久坐 (每周運動0-1天)</option>
                                <option value="1.375">輕度活動 (每周運動1-3天)</option>
                                <option value="1.55">中度活動 (每周運動3-5天)</option>
                                <option value="1.725">高度活動 (每周運動6-7天)</option>
                                <option value="1.9">極度活動 (體力勞動)</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">飲食法選擇(*請諮詢專家建議，慎選飲食法)</label>
                            <p class="view-mode w-full rounded-md p-2 bg-black/30" data-placeholder="標準均衡飲食">標準均衡飲食</p>
                            <select data-key="diet_plan" class="edit-mode hidden w-full rounded-md p-2 profile-input">
                                <option value="standard">標準均衡飲食 (預設)</option>
                                <option value="intermittent-fasting">168 斷食法</option>
                                <option value="keto">生酮飲食</option>
                                <option value="carb-cycling">碳循環飲食</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="text-sm text-gray-400">BMR</p>
                                <p id="bmr-display" class="text-2xl font-bold text-white">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">TDEE</p>
                                <p id="tdee-display" class="text-2xl font-bold text-white">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">飲水量(ml)</p>
                                <p id="water-display" class="text-2xl font-bold text-white">--</p>
                            </div>
                        </div>
                        
                        <div id="nutrition-goals-container" class="space-y-4 pt-4 border-t border-yellow-500/30">
                            <div id="template-standard-diet" class="space-y-3">
                                <div class="pt-2 border-t border-gray-700">
                                    <p class="text-sm text-center font-semibold text-gray-300 mb-2">維持目標</p>
                                    <div class="grid grid-cols-4 gap-2 text-center">
                                        <div><p class="text-xs text-gray-400">熱量</p><p data-goal="maintain-calories" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">蛋白</p><p data-goal="maintain-protein" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">脂肪</p><p data-goal="maintain-fat" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">碳水</p><p data-goal="maintain-carbs" class="font-semibold">--</p></div>
                                    </div>
                                </div>
                                <div class="pt-2 border-t border-gray-700">
                                    <p class="text-sm text-center font-semibold text-gray-300 mb-2">增肌目標</p>
                                    <div class="grid grid-cols-4 gap-2 text-center">
                                        <div><p class="text-xs text-gray-400">熱量</p><p data-goal="bulk-calories" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">蛋白</p><p data-goal="bulk-protein" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">脂肪</p><p data-goal="bulk-fat" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">碳水</p><p data-goal="bulk-carbs" class="font-semibold">--</p></div>
                                    </div>
                                </div>
                                <div class="pt-2 border-t border-gray-700">
                                    <p class="text-sm text-center font-semibold text-gray-300 mb-2">減脂目標</p>
                                    <div class="grid grid-cols-4 gap-2 text-center">
                                        <div><p class="text-xs text-gray-400">熱量</p><p data-goal="cut-calories" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">蛋白</p><p data-goal="cut-protein" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">脂肪</p><p data-goal="cut-fat" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">碳水</p><p data-goal="cut-carbs" class="font-semibold">--</p></div>
                                    </div>
                                </div>
                                <p data-diet-note="intermittent-fasting" class="hidden text-xs text-center text-yellow-300/80 pt-2">
                                    * 168斷食法著重於進食時間，建議將總熱量集中在 8 小時內攝取完畢。
                                </p>
                            </div>

                            <div id="template-keto-diet" class="hidden space-y-3">
                                <div class="pt-2 border-t border-yellow-500/30">
                                    <p class="text-sm text-center font-semibold text-yellow-400 mb-2">生酮飲食目標 (減脂)</p>
                                    <div class="grid grid-cols-4 gap-2 text-center">
                                        <div><p class="text-xs text-gray-400">熱量</p><p data-goal="keto-calories" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">蛋白</p><p data-goal="keto-protein" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">脂肪</p><p data-goal="keto-fat" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">碳水</p><p data-goal="keto-carbs" class="font-semibold">--</p></div>
                                    </div>
                                </div>
                                <p class="text-xs text-center text-yellow-300/80 pt-2">
                                    * 生酮飲食需嚴格控制碳水化合物攝取 (通常 < 50g)，並提高脂肪比例。
                                </p>
                            </div>

                            <div id="template-carb-cycling-diet" class="hidden space-y-3">
                                <div class="pt-2 border-t border-yellow-500/30">
                                    <p class="text-sm text-center font-semibold text-yellow-400 mb-2">高碳日目標 (訓練日)</p>
                                    <div class="grid grid-cols-4 gap-2 text-center">
                                        <div><p class="text-xs text-gray-400">熱量</p><p data-goal="highcarb-calories" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">蛋白</p><p data-goal="highcarb-protein" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">脂肪</p><p data-goal="highcarb-fat" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">碳水</p><p data-goal="highcarb-carbs" class="font-semibold">--</p></div>
                                    </div>
                                </div>
                                <div class="pt-2 border-t border-gray-700">
                                    <p class="text-sm text-center font-semibold text-gray-300 mb-2">低碳日目標 (休息日)</p>
                                    <div class="grid grid-cols-4 gap-2 text-center">
                                        <div><p class="text-xs text-gray-400">熱量</p><p data-goal="lowcarb-calories" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">蛋白</p><p data-goal="lowcarb-protein" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">脂肪</p><p data-goal="lowcarb-fat" class="font-semibold">--</p></div>
                                        <div><p class="text-xs text-gray-400">碳水</p><p data-goal="lowcarb-carbs" class="font-semibold">--</p></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-yellow-500/30">
                            <label class="block text-sm font-medium text-gray-300 mb-1">階段訓練方向</label>
                            <!-- 加入 whitespace-pre-wrap class -->
                            <p class="view-mode whitespace-pre-wrap w-full rounded-md p-2 bg-black/30" data-placeholder="無">無</p>
                            <textarea data-key="training_direction" rows="4" placeholder="記錄此階段的訓練目標與方向" class="edit-mode hidden w-full rounded-md p-2"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 全域資料編輯按鈕 -->
                <div id="profile-actions-container" class="mt-6">
                    <button id="edit-profile-btn" class="w-full bg-gray-700 hover:bg-gray-600 p-3 rounded-md font-semibold text-lg">更新個人資料</button>
                    <div id="edit-profile-actions" class="hidden grid grid-cols-2 gap-4">
                        <button id="cancel-profile-btn" class="w-full bg-gray-500 hover:bg-gray-400 text-black p-3 rounded-md font-semibold">取消</button>
                        <button id="save-profile-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 border border-yellow-400 text-black p-3 rounded-md font-semibold btn-glow">儲存全部變更</button>
                    </div>
                </div>

            </div>

            <!-- ==== 健身紀錄頁 ==== -->
            <div id="page-workout" class="page">
                <h2 class="text-2xl font-bold mb-4 text-center text-yellow-400 drop-shadow-[0_0_5px_rgba(255,195,0,0.5)] flex items-center justify-center">
                    <span>訓練日誌</span>                    
                </h2>
                <input type="date" id="workout-date-input" class="bg-transparent text-gray-400 border-none focus:ring-0 p-0 text-right">
                
                <div class="card p-2 rounded-lg mb-4 text-center">
                    <p class="text-sm text-gray-400">當日總容量</p>
                    <p id="daily-total-volume-display" class="text-3xl font-bold text-yellow-400">0 公斤</p>
                </div>

                <div id="workout-list" class="space-y-4">
                    <!-- 範例動作，實際由 JS 動態產生 -->
                </div>

                <div class="mt-6 grid grid-cols-2 gap-4">
                    <button id="add-exercise-btn" class="w-full bg-[#2d2a27] hover:bg-black border border-gray-600 p-3 rounded-md font-semibold">+ 新增動作</button>
                    <button id="load-template-btn" class="w-full bg-[#2d2a27] hover:bg-black border border-gray-600 p-3 rounded-md font-semibold">載入範本</button>
                    <button id="save-as-template-btn" class="w-full bg-[#2d2a27] hover:bg-black border border-gray-600 p-3 rounded-md font-semibold">另存為範本</button>
                    <button id="clear-workout-btn" class="w-full bg-red-800/80 hover:bg-red-700/100 border border-red-600 p-3 rounded-md font-semibold">全部刪除</button>
                    <button id="save-workout-btn" class="col-span-2 w-full bg-yellow-500 hover:bg-yellow-600 border border-yellow-400 text-black p-4 rounded-md font-semibold btn-glow text-lg">儲存本日訓練</button>
                </div>
            </div>

            <!-- ==== 成就紀錄頁 ==== -->
            <div id="page-prs" class="page">
                <div class="grid grid-cols-3 items-center mb-4">
        
                    <div></div>

                    <h2 class="text-2xl font-bold text-center text-yellow-400 drop-shadow-[0_0_5px_rgba(255,195,0,0.5)]">成就紀錄</h2>

                    <div class="justify-self-end">
                        <button id="edit-prs-btn" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md text-sm font-semibold">編輯分類</button>
                        <div id="prs-edit-actions" class="hidden flex space-x-2">
                            <button id="cancel-prs-btn" class="bg-gray-500 hover:bg-gray-400 text-black px-4 py-2 rounded-md text-sm font-semibold">取消</button>
                            <button id="save-prs-btn" class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-md text-sm font-semibold btn-glow">儲存變更</button>
                        </div>
                    </div>
                </div>

                <div id="prs-loading" class="text-center p-8 text-gray-400">
                    <p>正在載入個人紀錄...</p>
                </div>

                <div id="prs-content" class="hidden space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold text-yellow-500 mb-2 border-b border-yellow-500/30 pb-1">個人最佳紀錄 (Bests)</h3>
                        <div id="bests-container" class="space-y-3">
                            </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-yellow-500 mb-2 border-b border-yellow-500/30 pb-1">各RM區間紀錄 (Rep PRs)</h3>
                        <div id="rep-prs-container" class="space-y-4">
                            </div>
                    </div>
                </div>

                <div id="prs-empty" class="hidden text-center p-8 text-gray-400">
                    <ion-icon name="trophy-outline" class="text-5xl mx-auto mb-2"></ion-icon>
                    <p>尚未有任何個人紀錄。</p>
                    <p>當您的訓練超越過往表現時，紀錄將會自動出現在這裡。</p>
                </div>
            </div>

            <!-- ==== 體態記錄頁 ==== -->
            <div id="page-stats" class="page">
                 <h2 class="text-2xl font-bold mb-4 text-center text-yellow-400 drop-shadow-[0_0_5px_rgba(255,195,0,0.5)]">體態記錄</h2>
                
                 <div id="previous-photos-section" class="card p-4 rounded-lg space-y-2 mb-4">
                     <h3 class="text-lg font-semibold text-yellow-500 border-b border-yellow-500/30 pb-2">前一次體態記錄 (<span id="prev-photo-date">N/A</span>)</h3>
                     <div class="grid grid-cols-3 gap-2 text-center">
                         <div id="prev-photo-front-container" class="bg-black/30 aspect-square flex items-center justify-center rounded text-gray-500">尚無記錄</div>
                         <div id="prev-photo-side-container" class="bg-black/30 aspect-square flex items-center justify-center rounded text-gray-500">尚無記錄</div>
                         <div id="prev-photo-back-container" class="bg-black/30 aspect-square flex items-center justify-center rounded text-gray-500">尚無記錄</div>
                     </div>
                 </div>

                <button id="open-compare-modal-btn" class="w-full bg-[#2d2a27] hover:bg-black border border-gray-600 text-white font-bold py-3 px-4 rounded-md shadow-md transition duration-300 mb-4 flex items-center justify-center">
                    <ion-icon name="git-compare-outline" class="mr-2 text-xl"></ion-icon>
                    <span>開啟歷史對比</span>
                </button>

                <div class="card p-4 rounded-lg space-y-4">
                     <h3 class="text-lg font-semibold text-yellow-500 border-b border-yellow-500/30 pb-2">更新今日體態</h3>
                     <div>
                        <label for="photo-date-input" class="block text-sm font-medium text-gray-300">記錄日期</label>
                        <input type="date" id="photo-date-input" class="mt-1 w-full rounded-md p-2">
                    </div>
                    <div class="grid grid-cols-2 gap-4 pt-2">
                        <div>
                            <label for="photo-weight-input" class="block text-sm font-medium text-gray-300">體重 (kg)</label>
                            <input type="number" id="photo-weight-input" min="0" placeholder="例如: 75.5" class="mt-1 w-full rounded-md p-2">
                        </div>
                        <div>
                            <label for="photo-bodyfat-input" class="block text-sm font-medium text-gray-300">體脂率 (%)</label>
                            <input type="number" id="photo-bodyfat-input" min="0" placeholder="例如: 15.2" class="mt-1 w-full rounded-md p-2">
                        </div>
                    </div>
                    <div>
                        <label for="photo-front-upload" class="block text-sm font-medium text-gray-300">正面照片</label>
                        <input type="file" id="photo-front-upload" class="mt-1 w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-white hover:file:bg-gray-600 cursor-pointer">
                    </div>
                     <div>
                        <label for="photo-side-upload" class="block text-sm font-medium text-gray-300">側面照片</label>
                        <input type="file" id="photo-side-upload" class="mt-1 w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-white hover:file:bg-gray-600 cursor-pointer">
                    </div>
                     <div>
                        <label for="photo-back-upload" class="block text-sm font-medium text-gray-300">背面照片</label>
                        <input type="file" id="photo-back-upload" class="mt-1 w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-white hover:file:bg-gray-600 cursor-pointer">
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center mt-4">
                        <div id="photo-front-preview" class="bg-black/30 aspect-square flex items-center justify-center rounded text-gray-500">正面預覽</div>
                        <div id="photo-side-preview" class="bg-black/30 aspect-square flex items-center justify-center rounded text-gray-500">側面預覽</div>
                        <div id="photo-back-preview" class="bg-black/30 aspect-square flex items-center justify-center rounded text-gray-500">背面預覽</div>
                    </div>
                     <button id="save-photos-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 border border-yellow-400 text-black p-3 rounded-md font-semibold btn-glow">儲存體態照片</button>
                </div>

            </div>

             <!-- ==== 歷史紀錄頁 ==== -->
            <div id="page-history" class="page">
                <div class="flex justify-between items-center mb-4">
                    <div class="w-10 h-10"></div>
                    
                    <h2 class="text-2xl font-bold text-yellow-400 drop-shadow-[0_0_5px_rgba(255,195,0,0.5)]">資料分析</h2>
                    
                    <button id="refresh-analysis-btn" class="p-2 rounded-md text-gray-300 hover:bg-gray-700/50 hover:text-yellow-400 transition-colors">
                        <ion-icon name="refresh-outline" class="text-2xl pointer-events-none"></ion-icon>
                    </button>
                </div>

                <div id="history-loading" class="text-center p-8 text-gray-400">
                    <p>正在載入歷史數據...</p>
                </div>
                
                <div id="history-content" class="hidden space-y-6">
                    <div class="card p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-yellow-500 mb-3 text-center">訓練頻率熱力圖</h3>
                        <div id="heatmap-container" class="mx-auto w-full overflow-x-auto"></div>
                    </div>

                    <div class="card p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-yellow-500 mb-2 text-center">近 3 個月體態趨勢</h3>
                        <canvas id="body-stats-chart"></canvas>
                    </div>

                    <div class="card p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-yellow-500 mb-2 text-center">訓練量佔比</h3>
                        <div class="max-w-[300px] mx-auto"> <canvas id="category-distribution-chart"></canvas>
                        </div>
                        <div id="category-legend-container" class="mt-4 flex flex-wrap justify-center gap-x-4 gap-y-2">
                        </div>
                    </div> 

                    <div class="card p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-yellow-500 mb-2 text-center">近 3 個月訓練容量趨勢</h3>
                        <canvas id="volume-chart"></canvas> 
                    </div>                                       

                    <div class="card p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-yellow-500 mb-2 text-center">近 3 個月單一動作進步趨勢</h3>
                        <select id="exercise-progress-select" class="w-full rounded-md p-2 mb-4">
                            <option value="">請選擇一個動作來分析</option>
                        </select>
                        <canvas id="exercise-progress-chart"></canvas>
                        <div id="exercise-notes-container" class="mt-6 hidden space-y-3">
                            <h4 class="text-base font-semibold text-yellow-500 border-b border-yellow-500/30 pb-1">訓練備註</h4>
                        </div>
                    </div>
                </div>

                <div id="history-empty" class="hidden text-center p-8 text-gray-400">
                    <ion-icon name="analytics-outline" class="text-5xl mx-auto mb-2"></ion-icon>
                    <p>尚無足夠數據可供分析。</p>
                    <p>請先記錄您的個人資料與訓練日誌。</p>
                </div>
            </div>
        </main>
		
		    <div id="rest-timer-bar" class="hidden fixed bottom-16 left-0 right-0 max-w-lg mx-auto p-2 z-20">
            <div class="card flex items-center justify-between p-2 rounded-lg shadow-lg w-full">
                <button id="timer-minus-15" class="p-2 text-lg text-gray-400 hover:text-white">-15s</button>
                <div class="text-center">
                    <p class="text-3xl font-mono font-bold text-yellow-400" id="timer-display">00:30</p>
                    <p class="text-xs text-gray-500">休息倒數</p>
                </div>
                <button id="timer-plus-15" class="p-2 text-lg text-gray-400 hover:text-white">+15s</button>
                <button id="timer-reset" class="p-2 text-2xl text-red-500 hover:text-red-400">
                    <ion-icon name="close-circle-outline"></ion-icon>
                </button>
            </div>
        </div>
		
        <!-- 底部導覽列 -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-[#1c1a19]/80 border-t border-yellow-500/30 flex justify-around p-2 z-30 backdrop-filter backdrop-blur-sm">

            <button onclick="app.navigateTo('dashboard')" class="nav-item flex-1 flex justify-center items-center p-2 rounded-lg text-yellow-400 gap-2">
                <ion-icon name="person-circle-outline" class="text-2xl flex-shrink-0"></ion-icon>
                <span class="text-xs leading-tight">個人<br>資訊</span>
            </button>

            <button onclick="app.navigateTo('workout')" class="nav-item flex-1 flex justify-center items-center p-2 rounded-lg text-gray-400 hover:bg-gray-700/50 gap-2">
                <ion-icon name="barbell-outline" class="text-2xl flex-shrink-0"></ion-icon>
                <span class="text-xs">日誌</span>
            </button>

            <button onclick="app.navigateTo('prs')" class="nav-item flex-1 flex justify-center items-center p-2 rounded-lg text-gray-400 hover:bg-gray-700/50 gap-2">
                <ion-icon name="trophy-outline" class="text-2xl flex-shrink-0"></ion-icon>
                <span class="text-xs">成就</span>
            </button>

            <button onclick="app.navigateTo('stats')" class="nav-item flex-1 flex justify-center items-center p-2 rounded-lg text-gray-400 hover:bg-gray-700/50 gap-2">
                <ion-icon name="body-outline" class="text-2xl flex-shrink-0"></ion-icon>
                <span class="text-xs">體態</span>
            </button>

            <button onclick="app.navigateTo('history')" class="nav-item flex-1 flex justify-center items-center p-2 rounded-lg text-gray-400 hover:bg-gray-700/50 gap-2">
                <ion-icon name="stats-chart-outline" class="text-2xl flex-shrink-0"></ion-icon>
                <span class="text-xs">分析</span>
            </button>           

        </nav>
    </div>

    <script>
        // =======================================================
        // 全域常數定義 (Global Constants)
        // =======================================================
        const APP_CONSTANTS = {
            // 時間相關常數（毫秒）
            TIME: {
                ONE_DAY_MS: 24 * 60 * 60 * 1000,
                ONE_HOUR_MS: 60 * 60 * 1000,
                ONE_MINUTE_MS: 60 * 1000,
                
                // 便捷方法
                days(n) { return n * this.ONE_DAY_MS; },
                hours(n) { return n * this.ONE_HOUR_MS; },
                minutes(n) { return n * this.ONE_MINUTE_MS; }
            },
            
            // 分析數據時間範圍
            ANALYSIS: {
                DAYS_FOR_HISTORY: 90,        // 歷史數據顯示 90 天
                DAYS_FOR_DISTRIBUTION: 30,   // 訓練量分布顯示 30 天
                DAYS_FOR_PHOTO_REMINDER: 30  // 照片提醒週期 30 天
            },
            
            // UI 相關常數
            UI: {
                TOAST_DURATION: 3000,         // Toast 顯示時間 3 秒
                ANIMATION_DURATION: 300,      // 動畫時長 300ms
                DEBOUNCE_DELAY: 300,          // 防抖延遲 300ms
                CACHE_DURATION: 7200,         // 快取時長 2 小時（秒）
                SUGGESTIONS_LIMIT: 5          // 自動完成建議數量上限
            },
            
            // 圖表相關常數
            CHART: {
                ASPECT_RATIO: 1.6,            // 圖表寬高比
                POINT_RADIUS: 4,              // 資料點半徑
                POINT_HOVER_RADIUS: 8,        // 滑鼠懸停時的半徑
                POINT_HIT_RADIUS: 15          // 點擊檢測半徑
            },
            
            // 訓練相關常數
            WORKOUT: {
                DEFAULT_REST_TIME: 30,        // 預設休息時間 30 秒
                REST_TIME_ADJUSTMENT: 15,     // 休息時間調整間隔 15 秒
                MIN_WEIGHT: 0,                // 最小重量
                MAX_WEIGHT: 1000,             // 最大重量（公斤）
                MIN_REPS: 0,                  // 最小次數
                MAX_REPS: 999                 // 最大次數
            },
            
            // 身體數據範圍
            BODY_STATS: {
                MIN_AGE: 10,
                MAX_AGE: 150,
                MIN_HEIGHT: 50,               // 公分
                MAX_HEIGHT: 300,
                MIN_WEIGHT: 20,               // 公斤
                MAX_WEIGHT: 500,
                MIN_BODYFAT: 1,               // 百分比
                MAX_BODYFAT: 70
            },
            
            // 圖片處理
            IMAGE: {
                MAX_SIZE_MB: 1,               // 壓縮後最大檔案大小
                MAX_DIMENSION: 1080           // 最大寬度/高度
            },
            
            // 單位轉換
            CONVERSION: {
                KG_TO_LB: 2.20462262,
                LB_TO_KG: 0.45359237,
                CM_TO_INCH: 0.393701,
                INCH_TO_CM: 2.54
            },
            
            // 分類顏色（與圖表對應）
            COLORS: {
                CHEST: 'rgba(239, 68, 68, 0.8)',
                BACK: 'rgba(59, 130, 246, 0.8)',
                LEGS: 'rgba(34, 197, 94, 0.8)',
                GLUTES: 'rgba(249, 115, 22, 0.8)',
                SHOULDERS: 'rgba(168, 85, 247, 0.8)',
                ARMS: 'rgba(234, 179, 8, 0.8)',
                OTHER: 'rgba(156, 163, 175, 0.8)'
            }
        };
        // =======================================================
        // App Core Logic
        // =======================================================
        const app = {
            cache: {
                // 快取鍵值定義
                keys: {
                    ANALYSIS_DATA: 'analysisData',
                    PR_DATA: 'prData',
                    PHOTO_HISTORY: 'photoHistory',
                    WORKOUT_TEMPLATES: 'workoutTemplates'
                },
                
                // 清除單一快取
                clear(cacheKey) {
                    console.log(`清除快取: ${cacheKey}`);
                    if (cacheKey === this.keys.ANALYSIS_DATA) {
                        app.state.cache.analysisData = null;
                    } else if (cacheKey === this.keys.PR_DATA) {
                        app.state.cache.prData = null;
                    } else if (cacheKey === this.keys.PHOTO_HISTORY) {
                        app.state.cache.photoHistory = [];
                    } else if (cacheKey === this.keys.WORKOUT_TEMPLATES) {
                        app.state.cache.workoutTemplates = {};
                    }
                },
                
                // 清除所有快取
                clearAll() {
                    console.log('清除所有快取');
                    app.state.cache.analysisData = null;
                    app.state.cache.prData = null;
                    app.state.cache.photoHistory = [];
                    // workoutTemplates 通常不需要清除，因為它變動較少
                },
                
                // 清除與訓練相關的快取
                clearWorkoutRelated() {
                    console.log('清除訓練相關快取');
                    this.clear(this.keys.ANALYSIS_DATA);
                    this.clear(this.keys.PR_DATA);
                },
                
                // 清除與體態相關的快取
                clearBodyStatsRelated() {
                    console.log('清除體態相關快取');
                    this.clear(this.keys.ANALYSIS_DATA);
                    this.clear(this.keys.PHOTO_HISTORY);
                },
                
                // 檢查快取是否有效
                isValid(cacheKey, userEmail) {
                    let cacheData = null;
                    
                    if (cacheKey === this.keys.ANALYSIS_DATA) {
                        cacheData = app.state.cache.analysisData;
                    } else if (cacheKey === this.keys.PR_DATA) {
                        cacheData = app.state.cache.prData;
                    } else if (cacheKey === this.keys.PHOTO_HISTORY) {
                        cacheData = app.state.cache.photoHistory;
                    }
                    
                    // 檢查快取是否存在且屬於當前用戶
                    return cacheData && cacheData.currentUser === userEmail;
                }
            },

            // 🆕 重構後的狀態管理
            state: {
                // 使用者相關狀態
                user: {
                    currentUser: null,
                    isAdmin: false,
                    profileData: null
                },
                
                // UI 相關狀態
                ui: {
                    currentView: 'dashboard',
                    isLoading: true,
                    isPREditMode: false,
                    shouldShowReminder: false
                },
                
                // 資料快取
                cache: {
                    workoutTemplates: {},
                    exerciseNameList: [],
                    analysisData: null,
                    prData: null,
                    photoHistory: []
                },
                
                // Modal 相關狀態
                modal: {
                    promptCallback: null,
                    confirmCallback: null,
                    elementToDelete: null
                },
                
                // 🔍 確認這裡有正確定義
                charts: {
                    bodyStats: null,
                    volume: null,
                    categoryDistribution: null,
                    exerciseProgress: null,
                    heatmap: null
                },
                
                // 計時器相關
                timer: {
                    interval: null,
                    secondsLeft: 0,
                    toastTimer: null
                },
                
                // PR 編輯相關
                pr: {
                    categoryChanges: new Map()
                }
            },


            // 初始化 App
            init() {
                console.log('App 初始化...');
                this.ui.showLoading(true);
                if (!this.state.charts) {
                    this.state.charts = {
                        bodyStats: null,
                        volume: null,
                        categoryDistribution: null,
                        exerciseProgress: null,
                        heatmap: null
                    };
                }

                this.api.getInitialData().then(data => {
                    if (!data || data.error) {
                        throw new Error(data.error || "後端伺服器未返回有效的初始資料。");
                    }
                    
                    const { profile, allUsers, templates, exerciseNames } = data;

                    // 🆕 使用新的結構化狀態
                    this.state.user.currentUser = profile.email;
                    this.state.user.isAdmin = profile.isAdmin;
                    this.state.user.profileData = data.profile.profileData;
                    this.state.ui.shouldShowReminder = profile.shouldShowReminder;
                    this.state.cache.workoutTemplates = templates;
                    this.state.cache.exerciseNameList = exerciseNames;

                    this.ui.populateProfileData(profile.profileData);
                    this.methods.calculateRecommendations();
                    this.ui.populateLatestPhotos(profile.latestPhotos);
                    this.ui.populateTemplateList(templates);

                    if (this.state.user.isAdmin) {
                        this.ui.showAdminBar(true);
                        this.ui.populateUserSwitcher(allUsers);
                    }
                    if (this.state.ui.shouldShowReminder) {
                        this.ui.showReminderBanner(true);
                    }
                    
                    this.ui.updateWelcomeMessage(profile.name);
                    this.ui.setActiveNav('dashboard');
                    this.ui.showLoading(false);

                }).catch(error => {
                    app.methods.handleError(error, '初始化失敗');
                    this.ui.showLoading(false);
                });
                
                const workoutDateInput = document.getElementById('workout-date-input');
                if(workoutDateInput) workoutDateInput.value = new Date().toLocaleDateString('sv');
                
                const photoDateInput = document.getElementById('photo-date-input');
                if(photoDateInput) photoDateInput.value = new Date().toLocaleDateString('sv');
                
                this.events.init();
                this.methods.initSortable();
            },

            async navigateTo(page) {
                if (this.state.ui.currentView === page) return;

                this.state.ui.currentView = page;
                this.ui.renderPage();
                this.ui.setActiveNav(page);

                if (page === 'history') { await this.methods.loadHistoryData(); }
                if (page === 'prs') { await this.methods.loadPRData(); }
            },

            // 事件處理
            events: {
                _setupPhotoPreview(inputId, previewContainerId) {
                    const inputElement = document.getElementById(inputId);
                    const previewContainer = document.getElementById(previewContainerId);

                    if (inputElement && previewContainer) {
                        inputElement.addEventListener('change', (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                // 建立一個暫時的 URL 來預覽圖片
                                const previewUrl = URL.createObjectURL(file);
                                // ⭐ 修改：用 <a> 標籤包住 <img>，並加上 cursor-pointer 樣式
                                previewContainer.innerHTML = `<img src="${previewUrl}" data-fullsize-url="${previewUrl}" class="w-full h-full object-cover rounded cursor-pointer" alt="圖片預覽">`;
                            } else {
                                // 如果使用者取消選擇，可以回復到預設狀態
                                previewContainer.innerHTML = '<span class="text-gray-500">預覽</span>';
                            }
                        });
                    }
                },

                init() {
                    const userSwitcher = document.getElementById('user-switcher');
                    const dashboard = document.getElementById('page-dashboard');
                    const workoutPage = document.getElementById('page-workout');
                    const savePhotosBtn = document.getElementById('save-photos-btn');
                    
                    const promptModal = document.getElementById('prompt-modal');
                    const loadTemplateModal = document.getElementById('load-template-modal');
                    const confirmDeleteModal = document.getElementById('confirm-delete-modal');
                    const autocompleteModal = document.getElementById('autocomplete-modal');
                    const compareModal = document.getElementById('compare-photos-modal');
                    const openCompareBtn = document.getElementById('open-compare-modal-btn');

                    const timerBar = document.getElementById('rest-timer-bar');

                    const prsPage = document.getElementById('page-prs');
                    const historyPage = document.getElementById('page-history');

                    if (userSwitcher) {
                      userSwitcher.addEventListener('change', (e) => {
                        app.methods.switchUser(e.target.value);
                      });
                    }

                    if (historyPage) {
                        historyPage.addEventListener('click', this.handleHistoryPageClick.bind(this));
                    }

                    const refreshBtn = document.getElementById('refresh-analysis-btn');
                    if (refreshBtn) {
                        refreshBtn.addEventListener('click', app.methods.handleRefreshAnalysis);
                    }

                    if (dashboard) {
                        dashboard.addEventListener('click', this.handleDashboardClick.bind(this));
                        dashboard.addEventListener('input', this.handleDashboardInput.bind(this));
                        dashboard.addEventListener('change', this.handleDashboardInput.bind(this));
                    }
                    if (workoutPage) {
                        const workoutList = workoutPage.querySelector('#workout-list');
                        workoutPage.addEventListener('click', this.handleWorkoutPageClick.bind(this));
                        if(workoutList) {
                            workoutList.addEventListener('input', this.handleWorkoutListInput.bind(this));
                            workoutList.addEventListener('change', this.handleWorkoutListInput.bind(this));
                        }
                    }
                    if(savePhotosBtn) {
                        savePhotosBtn.addEventListener('click', app.methods.handleSaveBodyPhotos);
                    }
                    
                    if(promptModal) {
                        promptModal.querySelector('#prompt-cancel').addEventListener('click', () => 
                            app.ui.showPromptModal(false)
                        );
                        promptModal.querySelector('.modal-backdrop').addEventListener('click', () => 
                            app.ui.showPromptModal(false)
                        );
                        promptModal.querySelector('#prompt-confirm').addEventListener('click', () => {
                            // 🆕 使用新結構
                            if (app.state.modal.promptCallback) {
                                const input = document.getElementById('prompt-input').value;
                                app.state.modal.promptCallback(input);
                            }
                        });
                    }

                    if(loadTemplateModal) {
                        loadTemplateModal.querySelector('#load-template-cancel').addEventListener('click', () => app.ui.showLoadTemplateModal(false));
                        loadTemplateModal.querySelector('.modal-backdrop').addEventListener('click', () => app.ui.showLoadTemplateModal(false));
                        
                        // 修改這裡的事件監聽，以處理整個列表的點擊
                        loadTemplateModal.querySelector('#template-list').addEventListener('click', (e) => {
                            const loadBtn = e.target.closest('.js-load-template');
                            if (loadBtn) {
                                app.methods.handleLoadTemplate(loadBtn.dataset.templateName);
                            }

                            const deleteBtn = e.target.closest('.js-delete-template');
                            if (deleteBtn) {
                                app.methods.handleDeleteTemplate(deleteBtn.dataset.templateName);
                            }
                        });
                    }
                    
                    if(confirmDeleteModal){
                        confirmDeleteModal.querySelector('#cancel-delete').addEventListener('click', () => 
                            app.ui.showConfirmDeleteModal(false)
                        );
                        confirmDeleteModal.querySelector('.modal-backdrop').addEventListener('click', () => 
                            app.ui.showConfirmDeleteModal(false)
                        );
                        confirmDeleteModal.querySelector('#confirm-delete').addEventListener('click', () => {
                            // 🆕 使用新結構
                            if (app.state.modal.confirmCallback) {
                                app.state.modal.confirmCallback();
                            }
                            app.ui.showConfirmDeleteModal(false);
                        });
                    }
					
                    if(autocompleteModal){
                      autocompleteModal.querySelector('#autocomplete-cancel').addEventListener('click', () => app.ui.showAutocompleteModal(false));
                      autocompleteModal.querySelector('.modal-backdrop').addEventListener('click', () => app.ui.showAutocompleteModal(false));
                      autocompleteModal.querySelector('#autocomplete-confirm').addEventListener('click', () => {
                        if (app.state.modal.promptCallback) {
                          const input = document.getElementById('autocomplete-input').value;
                          app.state.modal.promptCallback(input);
                        }
                      });
                      // 當在輸入框打字時，更新建議列表
                      autocompleteModal.querySelector('#autocomplete-input').addEventListener('input', (e) => {
                        app.methods.updateAutocompleteSuggestions(e.target.value);
                      });
                      // 監聽整個建議列表的點擊事件
                      autocompleteModal.querySelector('#suggestions-list').addEventListener('click', (e) => {
                        if (e.target.classList.contains('js-suggestion-item')) {
                          const selectedName = e.target.textContent;
                          if (app.state.modal.promptCallback) {
                            app.state.modal.promptCallback(selectedName);
                          }
                        }
                      });
                    }
                    
                    if(openCompareBtn) {
                        openCompareBtn.addEventListener('click', app.methods.handleOpenCompareModal);
                    }

                    if(compareModal) {
                        compareModal.querySelector('#compare-modal-close').addEventListener('click', () => app.ui.showCompareModal(false));
                        compareModal.querySelector('.modal-backdrop').addEventListener('click', () => app.ui.showCompareModal(false));
                        compareModal.querySelector('#compare-select-before').addEventListener('change', (e) => app.methods.updateCompareImage('before', e.target.value));
                        compareModal.querySelector('#compare-select-after').addEventListener('change', (e) => app.methods.updateCompareImage('after', e.target.value));
                    }

                    if(timerBar){
                      timerBar.querySelector('#timer-plus-15').addEventListener('click', () => app.methods.addTimerTime(APP_CONSTANTS.WORKOUT.REST_TIME_ADJUSTMENT));
                      timerBar.querySelector('#timer-minus-15').addEventListener('click', () => app.methods.addTimerTime(-APP_CONSTANTS.WORKOUT.REST_TIME_ADJUSTMENT));
                      timerBar.querySelector('#timer-reset').addEventListener('click', () => app.methods.resetTimer());
                    }

                    const imageModal = document.getElementById('image-modal');
                    if (imageModal) {
                        imageModal.querySelector('#image-modal-close').addEventListener('click', app.ui.closeImageModal);
                        imageModal.querySelector('#image-modal-backdrop').addEventListener('click', app.ui.closeImageModal);
                    }

                    // 使用事件委派來處理所有圖片預覽的點擊事件
                    document.body.addEventListener('click', (e) => {
                        // 檢查被點擊的元素是否為圖片，並且有 data-fullsize-url 屬性
                        if (e.target.tagName === 'IMG' && e.target.dataset.fullsizeUrl) {
                            app.ui.openImageModal(e.target.dataset.fullsizeUrl);
                        }
                    });

                    if(prsPage) {
                        prsPage.addEventListener('click', this.handlePRsPageClick.bind(this));
                    }

                    this._setupPhotoPreview('photo-front-upload', 'photo-front-preview');
                    this._setupPhotoPreview('photo-side-upload', 'photo-side-preview');
                    this._setupPhotoPreview('photo-back-upload', 'photo-back-preview');

                },
                
                handleDashboardInput(event) {
                    if (event.target.closest('#card-basic-info') || event.target.closest('#card-recommendations')) {
                        app.methods.calculateRecommendations();
                    }
                },

                handleDashboardClick(event) {
                    const target = event.target;
                    
                    if (target.id === 'edit-profile-btn' || target.closest('#edit-profile-btn')) {
                        app.methods.toggleProfileEditMode(true);
                    }
                    if (target.id === 'save-profile-btn' || target.closest('#save-profile-btn')) {
                        app.methods.handleSaveProfile();
                    }
                    if (target.id === 'cancel-profile-btn' || target.closest('#cancel-profile-btn')) {
                        app.methods.toggleProfileEditMode(false);
                    }
                },

                handleWorkoutPageClick(event) {
                    const target = event.target;
                    if(target.id === 'add-exercise-btn' || target.closest('#add-exercise-btn')) app.methods.handleAddExerciseClick();
                    if(target.id === 'save-workout-btn' || target.closest('#save-workout-btn')) app.methods.handleSaveWorkout();
                    if(target.id === 'load-template-btn' || target.closest('#load-template-btn')) app.ui.showLoadTemplateModal(true);
                    if(target.id === 'save-as-template-btn' || target.closest('#save-as-template-btn')) app.methods.handleSaveAsTemplateClick();
                    if(target.id === 'clear-workout-btn' || target.closest('#clear-workout-btn')) app.methods.handleClearWorkoutClick();
                    
                    const exerciseCard = target.closest('.card');
                    if (!exerciseCard) return;

                    const addSetButton = target.closest('.js-add-set');
                    const deleteSetButton = target.closest('.js-delete-set');
                    const deleteExerciseButton = target.closest('.js-delete-exercise');
                    const copySetButton = target.closest('.js-copy-set');
					          const startTimerButton = target.closest('.js-start-timer');

                    if (addSetButton) app.methods.addSet(exerciseCard);
                    if (deleteSetButton) app.methods.deleteSet(deleteSetButton.closest('.js-set-row'));
                    if (deleteExerciseButton) app.methods.deleteExercise(exerciseCard);
                    if (copySetButton) app.methods.copyLastSet(exerciseCard);
					          if (startTimerButton) app.methods.startTimer(APP_CONSTANTS.WORKOUT.DEFAULT_REST_TIME); //
                },

                handleWorkoutListInput(event) {
                    const target = event.target;
                    if (target.matches('.js-weight-input, .js-reps-input, .js-unit-select')) {
                        const exerciseCard = target.closest('.card');
                        if (exerciseCard) {
                            app.methods.calculateVolume(exerciseCard);
                            app.methods.updateDailyTotalVolume();
                        }
                    }
                },

                handleHistoryPageClick(event) {
                    const commentBtn = event.target.closest('.js-admin-comment-btn');
                    if (commentBtn) {
                        app.methods.handleAdminCommentClick(commentBtn);
                    }
                },

                handlePRsPageClick(event) {
                    const target = event.target;
                    if (target.id === 'edit-prs-btn') app.methods.togglePREditMode(true);
                    if (target.id === 'cancel-prs-btn') app.methods.togglePREditMode(false);
                    if (target.id === 'save-prs-btn') app.methods.handleSavePRCategories();
                }
            },

            // 核心方法
            methods: {
                handleError(error, contextMessage = "發生錯誤") {
                    console.error(`[${contextMessage}]`, error); // 保留 console.error 供開發者除錯

                    let userFriendlyMessage = "請稍後再試。"; // 預設訊息

                    if (error instanceof Error) {
                        // 如果是標準 Error 物件，嘗試使用它的 message
                        userFriendlyMessage = error.message;
                    } else if (typeof error === 'string') {
                        // 如果錯誤本身就是字串
                        userFriendlyMessage = error;
                    } else if (error && typeof error === 'object' && error.message) {
                      // 處理來自 google.script.run 的錯誤物件 (通常有 message 屬性)
                      userFriendlyMessage = error.message;
                    }

                    // 組合訊息並顯示 Toast
                    app.ui.showToast(`${contextMessage}: ${userFriendlyMessage}`, 'error');
                },
                
                switchUser(selectedEmail) {
                    console.log(`管理者切換至: ${selectedEmail}`);
                    app.ui.showLoading(true);

                    // 🆕 使用快取管理系統清除所有快取
                    app.cache.clearAll();
    
                    app.ui.clearWorkoutLog();
                    if (app.state.charts.heatmap && typeof app.state.charts.heatmap.destroy === 'function') {
                        try {
                            app.state.charts.heatmap.destroy();
                            app.state.charts.heatmap = null;
                        } catch (e) {
                            console.warn('銷毀 heatmap 時發生錯誤:', e);
                        }
                    }

                    app.api.getInitialData(selectedEmail).then(data => {
                        if (!data || data.error) {
                            throw new Error(data.error || "切換使用者失敗。");
                        }
                        
                        const { profile, templates, exerciseNames } = data;

                        // 🆕 使用新結構更新狀態
                        app.state.user.currentUser = profile.email;
                        app.state.ui.shouldShowReminder = profile.shouldShowReminder;
                        app.state.cache.workoutTemplates = templates;
                        app.state.cache.exerciseNameList = exerciseNames;
                        app.state.user.profileData = data.profile.profileData;

                        app.ui.populateProfileData(profile.profileData);
                        app.methods.calculateRecommendations();
                        app.ui.populateLatestPhotos(profile.latestPhotos);
                        app.ui.populateTemplateList(templates);

                        app.ui.showReminderBanner(profile.shouldShowReminder);
                        app.ui.updateWelcomeMessage(profile.name);
                        
                        app.navigateTo('dashboard');

                    }).catch(error => {
                        this.handleError(error, '切換使用者失敗');
                    }).finally(() => {
                        app.ui.showLoading(false);
                    });
                },

                handleRefreshAnalysis() {
                    app.ui.showToast('正在重新載入分析數據...');
    
                    // 🆕 使用快取管理系統清除
                    app.cache.clear(app.cache.keys.ANALYSIS_DATA);
                    
                    app.methods.loadHistoryData();
                },

                initSortable() {
                    const workoutList = document.getElementById('workout-list');
                    if (workoutList) {
                        new Sortable(workoutList, {
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            chosenClass: 'sortable-chosen',
                            handle: '.js-drag-handle',
                            delay: 50,
                            delayOnTouchOnly: true
                        });
                    }
                },

                toggleProfileEditMode(isEditing) {
                    const profileSection = document.getElementById('profile-section');
                    if (!profileSection) return;

                    const viewElements = profileSection.querySelectorAll('.view-mode');
                    const editElements = profileSection.querySelectorAll('.edit-mode, .profile-input');
                    
                    if (isEditing) {
                        viewElements.forEach(viewEl => {
                            let editEl = viewEl.nextElementSibling;
                            if (!editEl || (!editEl.classList.contains('edit-mode') && !editEl.classList.contains('profile-input'))) {
                                const parentGrid = viewEl.closest('.grid');
                                if (parentGrid) {
                                    const placeholder = viewEl.dataset.placeholder;
                                    if(placeholder) {
                                       const key = placeholder.split(':')[0];
                                       editEl = parentGrid.querySelector(`[placeholder="${key}"]`);
                                    }
                                }
                            }
                           
                            if (editEl && (editEl.classList.contains('edit-mode') || editEl.classList.contains('profile-input'))) {
                                if (editEl.tagName === 'INPUT' || editEl.tagName === 'TEXTAREA') {
                                    const placeholder = viewEl.dataset.placeholder || '';
                                    let currentText = viewEl.textContent.trim();
                                    
                                    if(placeholder.includes(':')) {
                                        currentText = currentText.replace(placeholder.split(':')[0] + ':', '').trim();
                                    }

                                    editEl.value = (currentText === placeholder || currentText === '未設定' || currentText === '無' || currentText === '--') ? '' : currentText;
                                } else if (editEl.tagName === 'SELECT') {
                                    const matchingOption = [...editEl.options].find(opt => opt.textContent === viewEl.textContent);
                                    if (matchingOption) editEl.value = matchingOption.value;
                                }
                            } 
                        });
                    }

                    viewElements.forEach(el => el.classList.toggle('hidden', isEditing));
                    editElements.forEach(el => el.classList.toggle('hidden', !isEditing));
                    
                    const editBtn = document.getElementById('edit-profile-btn');
                    if(editBtn) editBtn.classList.toggle('hidden', isEditing);
                    
                    const editActions = document.getElementById('edit-profile-actions');
                    if(editActions) editActions.classList.toggle('hidden', !isEditing);
                },

                handleSaveProfile() {
                    const profileSection = document.getElementById('profile-section');
                    // `newDataFromForm` 只包含使用者在編輯模式下輸入的資料
                    const newDataFromForm = {};
                    
                    profileSection.querySelectorAll('[data-key]').forEach(el => {
                        // 只收集可見的 (即編輯模式下的) input/select 的值
                        if (el.offsetParent !== null) { 
                          newDataFromForm[el.dataset.key] = el.value;
                        }
                    });
                    
                    app.ui.showLoading(true);
                    
                    // 將新資料送到後端儲存 (這部分的 API 呼叫不變)
                    app.api.saveProfileData('profile-all', newDataFromForm)
                        .then(response => {
                            if (response.status === 'error') {
                                throw new Error(response.message);
                            }
                            app.ui.showToast(response.message);

                            // 🆕 更新個人資料後，清除分析資料快取（因為體重等可能影響分析）
                            app.cache.clear(app.cache.keys.ANALYSIS_DATA);

                            app.state.user.profileData = { ...app.state.user.profileData, ...newDataFromForm };
                            app.ui.populateProfileData(app.state.user.profileData);
                            app.methods.toggleProfileEditMode(false);
                            app.methods.calculateRecommendations();
                        })
                        .catch(err => {
                            this.handleError(err, '儲存個人資料失敗');
                        })
                        .finally(() => {
                            app.ui.showLoading(false);
                    });
                },

                async loadHistoryData() {
                    app.ui.showHistoryState('loading');
                    try {
                        // 🆕 使用快取管理系統檢查
                        if (!app.cache.isValid(app.cache.keys.ANALYSIS_DATA, app.state.user.currentUser)) {
                            console.log(`為 ${app.state.user.currentUser} 重新載入分析資料...`);
                            app.state.cache.analysisData = await app.api.getAnalysisData(app.state.user.currentUser);
                            if(app.state.cache.analysisData) {
                                app.state.cache.analysisData.currentUser = app.state.user.currentUser;
                            }
                        } else {
                            console.log(`使用 ${app.state.user.currentUser} 的快取分析資料`);
                        }
                        
                        const data = app.state.cache.analysisData;
                        if (data.error) throw new Error(data.error);

                        const hasData = data.weightHistory.length > 0 || 
                                      data.volumeHistory.length > 0 || 
                                      data.workoutFrequency.length > 0;
                        
                        if (hasData) {
                            this.renderHistoryCharts(data);
                            app.ui.showHistoryState('content');
                        } else {
                            app.ui.showHistoryState('empty');
                        }
                    } catch (error) {
                        this.handleError(error, '無法載入歷史數據');
                        app.ui.showHistoryState('empty');
                    }
                },

                renderHistoryCharts(data) {
                    Object.values(app.state.charts).forEach(chart => {
                        if (chart && typeof chart.destroy === 'function') {
                            try {
                                chart.destroy();
                            } catch (e) {
                                console.warn('銷毀圖表時發生錯誤:', e);
                            }
                        }
                    });

                    // --- 功能 4: 填充單一動作下拉選單 ---
                    this._populateExerciseSelect(data.singleExerciseProgress);
                    const exerciseSelect = document.getElementById('exercise-progress-select');
                    if (exerciseSelect) {
                        exerciseSelect.removeEventListener('change', this._handleExerciseSelectChange);
                        exerciseSelect.addEventListener('change', this._handleExerciseSelectChange);
                    } 

                    // --- 圖表 1: 體態趨勢 ---
                    const bodyStatsCtx = document.getElementById('body-stats-chart');
                    if (bodyStatsCtx) {
                        app.state.charts.bodyStats = new Chart(bodyStatsCtx.getContext('2d'), {
                            type: 'line',
                            data: { datasets: [ { label: '體重 (kg)', data: data.weightHistory, borderColor: '#ffc300', backgroundColor: 'rgba(255, 195, 0, 0.2)', yAxisID: 'y', tension: 0.1, fill: true, }, { label: '體脂率 (%)', data: data.bodyfatHistory, borderColor: '#38bdf8', backgroundColor: 'rgba(56, 189, 248, 0.2)', yAxisID: 'y1', tension: 0.1, fill: true, } ] },
                            options: {
                                responsive: true,
                                aspectRatio: 1.6,
                                interaction: { mode: 'index', intersect: false },
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: { unit: 'day', displayFormats: { day: 'MMM d' }, tooltipFormat: 'yyyy-MM-dd' },
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        ticks: { color: '#9ca3af' }
                                    },
                                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: '體重 (kg)', color: '#ffc300' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#ffc300' } },
                                    y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: '體脂率 (%)', color: '#38bdf8' }, grid: { drawOnChartArea: false }, ticks: { color: '#38bdf8' } }
                                },
                                plugins: {
                                    legend: { labels: { color: '#e5e7eb' } },
                                    datalabels: { display: false }
                                }
                            }
                        });
                    }                    

                    // --- 圖表 2: 訓練容量分佈 (V4 - 簡化為總容量折線圖並修正點擊) ---
                    const volumeCtx = document.getElementById('volume-chart');
                    if (volumeCtx && data.volumeHistory) {
                        // ✨✨✨ 關鍵修正 1：直接使用後端已算好的總容量數據 volumeHistory ✨✨✨
                        app.state.charts.volume = new Chart(volumeCtx.getContext('2d'), {
                            type: 'line', // 改為折線圖更清晰
                            data: {
                                datasets: [{
                                    label: '總訓練容量 (kg)',
                                    data: data.volumeHistory, // 直接使用總容量數據
                                    borderColor: '#4ade80', // 綠色
                                    backgroundColor: 'rgba(74, 222, 128, 0.2)',
                                    fill: true,
                                    tension: 0.1,
                                    pointRadius: 4,          // 點的半徑 (可見)
                                    pointHoverRadius: 8,     // 滑鼠懸停/點擊時的半徑 (可見)
                                    pointHitRadius: 15       // 點擊的偵測半徑 (不可見)
                                }]
                            },
                            options: {
                                responsive: true,
                                aspectRatio: 1.6,
                                plugins: {
                                    legend: { display: false }, // 不需要圖例了
                                    tooltip: {
                                        callbacks: {
                                            label: (context) => `${context.dataset.label}: ${context.raw.y.toLocaleString()} kg`
                                        }
                                    },
                                    datalabels: { display: false }
                                },
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: { unit: 'day', displayFormats: { day: 'MMM d' }, tooltipFormat: 'yyyy-MM-dd' },
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        ticks: { color: '#9ca3af' }
                                    },
                                    y: {
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        ticks: { color: '#e5e7eb' },
                                        beginAtZero: true,
                                        title: { display: true, text: '訓練容量 (kg)', color: '#e5e7eb' }
                                    }
                                },
                                // ✨✨✨ 關鍵修正 2：onClick 現在可以正確運作 ✨✨✨
                                onClick: (event, elements, chart) => {
                                    if (elements.length === 0) return;
                                    
                                    const clickedIndex = elements[0].index;
                                    // 對於非堆疊圖表，可以直接從 data.datasets[0].data 取得對應的資料點
                                    const clickedDataPoint = chart.data.datasets[0].data[clickedIndex];
                                    const clickedDateISO = clickedDataPoint.x; // 這就是正確的 ISO 日期字串

                                    const targetDate = new Date(clickedDateISO);
                                    targetDate.setHours(0,0,0,0); // 標準化為當天零點

                                    const exercisesOnDay = [];
                                    const allProgressData = app.state.cache.analysisData.singleExerciseProgress;
                                    for (const exercise in allProgressData) {
                                        const hasDataOnDay = allProgressData[exercise].some(dataPoint => {
                                            const recordDate = new Date(dataPoint.x);
                                            recordDate.setHours(0,0,0,0);
                                            return recordDate.getTime() === targetDate.getTime();
                                        });

                                        if (hasDataOnDay) {
                                            exercisesOnDay.push(exercise);
                                        }
                                    }
                                    
                                    const selectEl = document.getElementById('exercise-progress-select');

                                    if (exercisesOnDay.length > 0) {
                                        app.methods._populateExerciseSelect(allProgressData, exercisesOnDay);
                                        selectEl.value = exercisesOnDay[0];
                                        selectEl.dispatchEvent(new Event('change'));

                                        // 讓頁面滾動到下拉選單的位置，方便查看
                                        selectEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }
                                }
                            }
                        });
                    }

                    // --- 圖表 3: 肌肉部位訓練量佔比 (V3 - 修正圖例順序) ---
                    const categoryCtx = document.getElementById('category-distribution-chart');
                    const legendContainer = document.getElementById('category-legend-container');

                    if (categoryCtx && legendContainer && data.categoryVolumeDistribution && Object.keys(data.categoryVolumeDistribution).length > 0) {
                        
                        // ✨ 修正 1：定義固定的圖例順序
                        const fixedCategoryOrder = ['胸', '肩', '背', '臀', '腿', '手', '其他'];
                        const originalLabels = Object.keys(data.categoryVolumeDistribution);
                        
                        // 根據固定順序篩選和排序已存在的標籤
                        const sortedCategoryLabels = fixedCategoryOrder.filter(label => originalLabels.includes(label));
                        
                        // 找出不在固定順序中但卻存在的標籤 (以防未來有新分類)，並加到尾部
                        originalLabels.forEach(label => {
                            if (!sortedCategoryLabels.includes(label)) {
                                sortedCategoryLabels.push(label);
                            }
                        });
                        
                        // 根據排序好的標籤，重新產生對應的數據陣列
                        const sortedCategoryData = sortedCategoryLabels.map(label => data.categoryVolumeDistribution[label]);

                        const categoryColors = {
                            '胸': 'rgba(239, 68, 68, 0.8)', '背': 'rgba(59, 130, 246, 0.8)',
                            '腿': 'rgba(34, 197, 94, 0.8)', '臀': 'rgba(249, 115, 22, 0.8)',
                            '肩': 'rgba(168, 85, 247, 0.8)', '手': 'rgba(234, 179, 8, 0.8)',
                            '其他': 'rgba(156, 163, 175, 0.8)'
                        };
                        const backgroundColors = sortedCategoryLabels.map(label => categoryColors[label] || categoryColors['其他']);

                        if (app.state.charts.categoryDistribution) {
                            app.state.charts.categoryDistribution.destroy();
                        }

                        app.state.charts.categoryDistribution = new Chart(categoryCtx.getContext('2d'), {
                            type: 'doughnut',
                            data: {
                                labels: sortedCategoryLabels, // 使用排序後的標籤
                                datasets: [{
                                    data: sortedCategoryData, // 使用排序後的數據
                                    backgroundColor: backgroundColors,
                                    borderColor: '#2d2a27',
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { display: false },
                                    datalabels: {
                                        formatter: (value, ctx) => {
                                            const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const percentage = (value * 100 / sum);
                                            return percentage < 5 ? '' : percentage.toFixed(0) + '%';
                                        },
                                        color: '#FFFFFF', font: { weight: 'bold', size: 16 },
                                        textStrokeColor: '#000000', textStrokeWidth: 2
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = '';
                                                if (context.raw !== null) {
                                                    // 使用 toLocaleString() 讓數字加上千分位符號，更好閱讀
                                                    label += context.raw.toLocaleString() + ' kg';
                                                }
                                                return label;
                                            }
                                        }
                                    }
                                }                                
                            }
                        });

                        legendContainer.innerHTML = '';
                        // ✨ 修正 1：使用排序後的標籤來產生圖例
                        app.state.charts.categoryDistribution.data.labels.forEach((label, index) => {
                            const color = backgroundColors[index];
                            const legendItemHtml = `
                                <div class="flex items-center">
                                    <span class="w-3 h-3 rounded-sm mr-2" style="background-color: ${color}"></span>
                                    <span class="text-gray-300 text-sm">${label}</span>
                                </div>
                            `;
                            legendContainer.innerHTML += legendItemHtml;
                        });
                    }

                    // --- 圖表 3: 訓練頻率熱力圖 ---
                    this._renderWorkoutHeatmap(data.workoutFrequency);                                       
                },

                _renderWorkoutHeatmap(frequencyData) {
                    if (app.state.charts.heatmap && typeof app.state.charts.heatmap.destroy === 'function') {
                        try {
                            app.state.charts.heatmap.destroy();
                            app.state.charts.heatmap = null;
                        } catch (e) {
                            console.warn('銷毀 heatmap 時發生錯誤:', e);
                        }
                    }
                    
                    const container = document.getElementById('heatmap-container');
                    if (!container || !frequencyData || frequencyData.length === 0) {
                        if (container) container.innerHTML = '';
                        return;
                    }

                    setTimeout(() => {
                        const cal = new CalHeatmap();
                        
                        const heatmapData = frequencyData.map(dateStr => ({
                            date: dateStr,
                            value: 1
                        }));

                        // === [修正] 更精確的起始日期計算方式 ===
                        const now = new Date();
                        // 直接建立一個新的 Date 物件，設定為 2 個月前的 1 號
                        // 例如：10月執行時，now.getMonth() 是 9，9-2=7，代表 8 月
                        const startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        // === [修正] 程式碼結束 ===

                        cal.paint({
                            itemSelector: container,
                            domain: {
                                type: 'month',
                                label: { text: 'MMM', textAlign: 'start', position: 'top' },
                            },
                            subDomain: { type: 'day', radius: 2, width: 11, height: 11, gutter: 4 },
                            data: {
                                source: heatmapData,
                                x: 'date',
                                y: 'value'
                            },
                            date: { start: startDate }, // <--- 確保這裡使用的是 startDate
                            range: 3, // 顯示 3 個月的範圍
                            scale: {
                                color: {
                                    type: 'threshold',
                                    scheme: 'YlGn',
                                    domain: [1],
                                },
                            },
                            theme: 'dark'
                        });
                        
                        app.state.charts.heatmap = cal;
                    }, 50);
                },

                _populateExerciseSelect(progressData, filterList = null) {
                    const selectEl = document.getElementById('exercise-progress-select');
                    if (!selectEl || !progressData) return;
                    selectEl.innerHTML = '<option value="">請選擇一個動作來分析</option>';

                    // 如果有傳入 filterList，就用它當作選項；否則，就用全部的動作名稱
                    const exerciseNames = filterList ? filterList.sort() : Object.keys(progressData).sort();

                    exerciseNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        selectEl.appendChild(option);
                    });
                },

                _handleExerciseSelectChange(event) {
                    const exerciseName = event.target.value;
                    const progressData = app.state.cache.analysisData.singleExerciseProgress;
                    app.methods._renderExerciseProgressChart(exerciseName, progressData);
                },

                _renderExerciseProgressChart(exerciseName, allProgressData) {
                    const ctx = document.getElementById('exercise-progress-chart')?.getContext('2d');
                    const notesContainer = document.getElementById('exercise-notes-container');
                    if (!ctx || !notesContainer) return;

                    notesContainer.innerHTML = '<h4 class="text-base font-semibold text-yellow-500 border-b border-yellow-500/30 pb-1">訓練備註</h4>';
                    notesContainer.classList.add('hidden');
                    if (app.state.charts.exerciseProgress && typeof app.state.charts.exerciseProgress.destroy === 'function') {
                        try {
                            app.state.charts.exerciseProgress.destroy();
                        } catch (e) {
                            console.warn('銷毀 exerciseProgress 圖表時發生錯誤:', e);
                        }
                    }
                    if (!exerciseName) {
                        return;
                    }

                    const exerciseData = allProgressData[exerciseName];
                    let notesFound = 0;

                    exerciseData.forEach(d => {
                        const hasUserNote = d.note && d.note.trim() !== '';
                        const hasAdminNote = d.adminNote && d.adminNote.trim() !== '';

                        // 判斷是否需要顯示此日期的備註區塊 (邏輯不變)
                        if (hasUserNote || hasAdminNote || app.state.user.isAdmin) {
                            notesFound++;
                            
                            const noteDate = new Date(d.x).toLocaleDateString('sv');
                            
                            let noteHtml = `<div class="bg-black/40 p-3 rounded-md space-y-3">`;

                            // ⭐ [修改 1/3] 無條件顯示日期，因為只要能進到這個 if 區塊，就代表需要顯示日期
                            noteHtml += `<p class="text-sm font-semibold text-gray-400">${noteDate}</p>`;
                            
                            // ⭐ [修改 2/3] 如果有使用者備註，則顯示備註內容 (不再包含日期)
                            if (hasUserNote) {
                                noteHtml += `
                                    <div class="pl-2 border-l-2 border-gray-600">
                                        <p class="text-xs text-gray-500">您的備註</p>
                                        <p class="text-base text-gray-200 whitespace-pre-wrap">${d.note}</p>
                                    </div>
                                `;
                            }
                            
                            // 建立管理員區塊 (邏輯不變)
                            let adminSection = '';
                            if (hasAdminNote) {
                                adminSection += `
                                    <div>
                                        <p class="text-sm font-semibold text-yellow-400 mb-1">
                                            <ion-icon name="ribbon-outline" class="mr-1"></ion-icon>指導建議
                                        </p>
                                        <p class="text-base text-yellow-200/90 whitespace-pre-wrap">${d.adminNote}</p>
                                    </div>
                                `;
                            }
                            if (app.state.user.isAdmin) {
                                adminSection += `
                                    <div class="pt-2 text-right">
                                        <button class="js-admin-comment-btn text-sm text-yellow-500 hover:text-yellow-300 font-semibold"
                                                data-date="${noteDate}" 
                                                data-motion="${exerciseName}"
                                                data-current-comment="${d.adminNote || ''}">
                                            ${hasAdminNote ? '編輯建議' : '新增建議'}
                                        </button>
                                    </div>
                                `;
                            }

                            // ⭐ [修改 3/3] 只有在同時有「使用者備註」和「管理員區塊」時，才新增分隔線
                            if (hasUserNote && adminSection.trim() !== '') {
                                noteHtml += `<div class="border-t border-yellow-500/30 pt-3 mt-3">` + adminSection + `</div>`;
                            } else {
                                noteHtml += adminSection;
                            }

                            noteHtml += `</div>`;
                            notesContainer.innerHTML += noteHtml;
                        }
                    });

                    if (notesFound > 0) {
                        notesContainer.classList.remove('hidden');
                    }

                    // --- Chart.js 繪圖程式碼 (保持不變) ---
                    app.state.charts.exerciseProgress = new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: [
                                {
                                    label: '最大重量 (kg)',
                                    data: exerciseData.map(d => ({ x: d.x, y: d.maxWeight })),
                                    borderColor: '#ffc300',
                                    yAxisID: 'y_weight',
                                    tension: 0.1,
                                },
                                {
                                    label: '推估 1RM (kg)',
                                    data: exerciseData.map(d => ({ x: d.x, y: d.bestE1RM })),
                                    borderColor: '#f87171',
                                    borderDash: [5, 5],
                                    yAxisID: 'y_weight',
                                    tension: 0.1,
                                },
                                {
                                    label: '總訓練量 (kg)',
                                    data: exerciseData.map(d => ({ x: d.x, y: d.totalVolume })),
                                    borderColor: '#38bdf8',
                                    yAxisID: 'y_volume',
                                    tension: 0.1,
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            aspectRatio: 1.6,
                            interaction: { mode: 'index', intersect: false },
                            scales: {
                                x: { 
                                    type: 'time', 
                                    time: { 
                                        unit: 'day',
                                        displayFormats: { day: 'MMM d' }
                                    },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { color: '#9ca3af' }
                                },
                                y_weight: {
                                    type: 'linear', display: true, position: 'left',
                                    title: { display: true, text: '重量 (kg)', color: '#ffc300' },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { color: '#ffc300' }
                                },
                                y_volume: {
                                    type: 'linear', display: true, position: 'right',
                                    title: { display: true, text: '總訓練量 (kg)', color: '#38bdf8' },
                                    grid: { drawOnChartArea: false },
                                    ticks: { color: '#38bdf8' }
                                }
                            },
                            plugins: { 
                                legend: { labels: { color: '#e5e7eb' } },
                                datalabels: {
                                    display: false
                                }
                            }
                        }
                    });
                },

                async handleSaveBodyPhotos() {
                    const dateInput = document.getElementById('photo-date-input');
                    const weightInput = document.getElementById('photo-weight-input');
                    const bodyfatInput = document.getElementById('photo-bodyfat-input');
                    const photoInputs = {
                        front: document.getElementById('photo-front-upload'),
                        side: document.getElementById('photo-side-upload'),
                        back: document.getElementById('photo-back-upload')
                    };

                    const files = {
                        front: photoInputs.front.files[0],
                        side: photoInputs.side.files[0],
                        back: photoInputs.back.files[0]
                    };

                    const weightValue = weightInput.value;
                    const bodyfatValue = bodyfatInput.value;
                    const hasPhotos = files.front || files.side || files.back;
                    const hasData = weightValue || bodyfatValue;

                    if (!hasPhotos && !hasData) {
                        app.ui.showToast('請至少上傳一張照片或填寫一項身體數據。', 'error');
                        return;
                    }

                    app.ui.showLoading(true);

                    const photoData = { 
                        date: dateInput.value,
                        weight: weightValue,
                        bodyfat: bodyfatValue
                    };

                    // 🆕 優化：使用 Promise.all 並行壓縮所有照片
                    const compressionTasks = [];
                    
                    if (files.front) {
                        compressionTasks.push(
                            app.methods._compressAndReadFileAsBase64(files.front)
                                .then(base64 => ({ type: 'front', data: base64 }))
                        );
                    }
                    if (files.side) {
                        compressionTasks.push(
                            app.methods._compressAndReadFileAsBase64(files.side)
                                .then(base64 => ({ type: 'side', data: base64 }))
                        );
                    }
                    if (files.back) {
                        compressionTasks.push(
                            app.methods._compressAndReadFileAsBase64(files.back)
                                .then(base64 => ({ type: 'back', data: base64 }))
                        );
                    }

                    try {
                        // ✅ 並行處理所有照片壓縮（比原本快 3 倍！）
                        const compressedPhotos = await Promise.all(compressionTasks);
                        
                        // 將結果填入 photoData
                        compressedPhotos.forEach(photo => {
                            photoData[photo.type] = photo.data;
                        });

                        const response = await app.api.saveBodyPhotos(photoData);
                        
                        if (response.status === 'error') {
                            throw new Error(response.message);
                        }
                        
                        app.ui.showToast(response.message);
                        app.cache.clearBodyStatsRelated();

                        // 清空輸入框
                        photoInputs.front.value = '';
                        photoInputs.side.value = '';
                        photoInputs.back.value = '';
                        weightInput.value = '';
                        bodyfatInput.value = '';

                        document.getElementById('photo-front-preview').innerHTML = '<span class="text-gray-500">正面預覽</span>';
                        document.getElementById('photo-side-preview').innerHTML = '<span class="text-gray-500">側面預覽</span>';
                        document.getElementById('photo-back-preview').innerHTML = '<span class="text-gray-500">背面預覽</span>';

                        if (response.latestPhotos) {
                            app.ui.populateLatestPhotos(response.latestPhotos);
                        }
                        if(response.updatedProfileData){
                            app.ui.populateProfileData(response.updatedProfileData);
                            app.methods.calculateRecommendations();
                        }

                    } catch (error) {
                        this.handleError(error, '照片上傳失敗');
                    } finally {
                        app.ui.showLoading(false);
                    }
                },

                async _compressAndReadFileAsBase64(file) {
                    // 🆕 使用常數
                    const options = {
                        maxSizeMB: APP_CONSTANTS.IMAGE.MAX_SIZE_MB,
                        maxWidthOrHeight: APP_CONSTANTS.IMAGE.MAX_DIMENSION,
                        useWebWorker: true
                    };

                    try {
                        console.log(`原始圖片大小: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                        const compressedFile = await imageCompression(file, options);
                        console.log(`壓縮後圖片大小: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);

                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = error => reject(error);
                            reader.readAsDataURL(compressedFile);
                        });
                    } catch (error) {
                        console.error('圖片壓縮失敗:', error);
                        throw new Error('圖片壓縮失敗，請稍後再試。');
                    }
                },

                calculateRecommendations() {
                    const basicInfoCard = document.getElementById('card-basic-info');
                    const recommendationsCard = document.getElementById('card-recommendations');

                    // ⭐ [修正 1/3] 採用更穩健的 getVal 函式，直接從 profileData 狀態讀取，不再依賴解析 UI
                    const getVal = (key) => {
                        // app.state.user.profileData 是在 App 初始化時從後端獲取的原始、乾淨的資料
                        const value = app.state.user.profileData ? app.state.user.profileData[key] : null;
                        
                        // 特別處理 select 元素，因為它們儲存的是 value，但我們需要的是數字
                        if (key === 'frequency' && value) {
                            return value; // frequency 的 value 本身就是數字
                        }
                        if (key === 'diet_plan' && value) {
                            return value;
                        }
                        return value || null;
                    };

                    const weight = parseFloat(getVal('weight'));
                    const height = parseFloat(getVal('height'));
                    const age = parseInt(getVal('age'));
                    const gender = getVal('gender');
                    const activityLevel = parseFloat(getVal('frequency'));
                    const dietPlan = getVal('diet_plan') || 'standard';

                    const display = (goal, value) => {
                        const el = document.querySelector(`#nutrition-goals-container [data-goal="${goal}"]`);
                        if (el) el.textContent = (value !== null && !isNaN(value)) ? Math.round(value) : '--';
                    };

                    const displayBMR = (id, value) => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = (value !== null && !isNaN(value)) ? Math.round(value) : '--';
                    };

                    // 隱藏所有範本，稍後再根據選擇顯示
                    document.querySelectorAll('#nutrition-goals-container > div').forEach(el => el.classList.add('hidden'));
                    document.querySelectorAll('[data-diet-note]').forEach(el => el.classList.add('hidden'));
                    
                    // 如果基本資料不全，清空所有數據並返回
                    if (!weight || !height || !age || !gender || !activityLevel) {
                        displayBMR('bmr-display', null);
                        displayBMR('tdee-display', null);
                        displayBMR('water-display', null);
                        document.getElementById('template-standard-diet').classList.remove('hidden');
                        return;
                    }

                    let bmr = (gender === 'male') 
                        ? (10 * weight + 6.25 * height - 5 * age + 5)
                        : (10 * weight + 6.25 * height - 5 * age - 161);
                    
                    const tdee = bmr * activityLevel;
                    const water = weight * 35;
                    
                    // ⭐ [修正 2/3] BMR 欄位現在改回顯示 BMR，TDEE 欄位顯示 TDEE
                    displayBMR('bmr-display', bmr);
                    displayBMR('tdee-display', tdee);
                    displayBMR('water-display', water);

                    // --- 根據選擇的飲食法，執行不同的計算和 UI 更新 ---
                    switch (dietPlan) {
                        case 'intermittent-fasting':
                            document.querySelector('[data-diet-note="intermittent-fasting"]').classList.remove('hidden');
                        case 'standard':
                            document.getElementById('template-standard-diet').classList.remove('hidden');
                            
                            let protM = weight * 1.6, fatM = weight * 0.8;
                            display('maintain-calories', tdee);
                            display('maintain-protein', protM);
                            display('maintain-fat', fatM);
                            display('maintain-carbs', (tdee - protM*4 - fatM*9) / 4);
                            
                            let protB = weight * 2.0, fatB = weight * 1.0;
                            display('bulk-calories', tdee + 300);
                            display('bulk-protein', protB);
                            display('bulk-fat', fatB);
                            display('bulk-carbs', (tdee + 300 - protB*4 - fatB*9) / 4);

                            let protC = weight * 2.2, fatC = weight * 0.8;
                            display('cut-calories', tdee - 300);
                            display('cut-protein', protC);
                            display('cut-fat', fatC);
                            display('cut-carbs', (tdee - 300 - protC*4 - fatC*9) / 4);
                            break;

                        case 'keto':
                            document.getElementById('template-keto-diet').classList.remove('hidden');
                            const ketoCals = tdee - 400;
                            const ketoProt = weight * 1.5;
                            const ketoCarbs = 25;
                            const ketoFat = (ketoCals - ketoProt*4 - ketoCarbs*4) / 9;
                            
                            display('keto-calories', ketoCals);
                            display('keto-protein', ketoProt);
                            display('keto-fat', ketoFat);
                            display('keto-carbs', ketoCarbs);
                            break;
                        
                        case 'carb-cycling':
                            document.getElementById('template-carb-cycling-diet').classList.remove('hidden');
                            
                            const hcCals = tdee + 200;
                            const hcProt = weight * 2.0;
                            const hcFat = weight * 0.6;
                            const hcCarbs = (hcCals - hcProt*4 - hcFat*9) / 4;
                            
                            display('highcarb-calories', hcCals);
                            display('highcarb-protein', hcProt);
                            display('highcarb-fat', hcFat);
                            display('highcarb-carbs', hcCarbs);

                            const lcCals = tdee - 400;
                            const lcProt = weight * 2.2;
                            const lcFat = weight * 1.0;
                            const lcCarbs = (lcCals - lcProt*4 - lcFat*9) / 4;

                            display('lowcarb-calories', lcCals);
                            display('lowcarb-protein', lcProt);
                            display('lowcarb-fat', lcFat);
                            display('lowcarb-carbs', lcCarbs);
                            break;
                    }
                },

                handleSaveWorkout() {
                    const workoutData = app.methods.collectWorkoutData();
                    if (workoutData.length === 0) {
                        app.ui.showToast('沒有任何訓練資料可以儲存。');
                        return;
                    }

                    app.ui.showLoading(true);
                    
                    app.api.saveWorkoutData(workoutData)
                        .then(response => {
                            app.ui.showToast(response.message);
                            
                            // 🆕 儲存成功後，立即清除相關快取
                            app.cache.clearWorkoutRelated();
                            
                            return app.api.processWorkoutForPRs(workoutData);
                        })
                        .then(prResponse => {
                            if (prResponse && prResponse.status === 'success' && prResponse.newPRs.length > 0) {
                                const prMessage = "<strong>恭喜達成新紀錄！</strong><br>" + prResponse.newPRs.join("<br>");
                                app.ui.showToast(prMessage);
                            }
                        })
                        .catch(error => {
                            this.handleError(error, '儲存訓練日誌或處理 PR 失敗');
                        })
                        .finally(() => {
                            app.ui.showLoading(false);
                        });
                },

                collectWorkoutData() {
                    const LB_TO_KG = 0.45359237;
                    const allExerciseCards = document.querySelectorAll('#workout-list .card');
                    const workoutData = [];
                    const selectedDateString = document.getElementById('workout-date-input').value;

                    const now = new Date();
                    const finalDate = new Date(selectedDateString);

                    finalDate.setHours(now.getHours());
                    finalDate.setMinutes(now.getMinutes());
                    finalDate.setSeconds(now.getSeconds());

                    const dateToSave = finalDate.toISOString();

                    allExerciseCards.forEach(card => {
                      const exerciseName = card.querySelector('h3').textContent;
                      const note = card.querySelector('.js-exercise-note').value; // 讀取備註
                      const sets = card.querySelectorAll('.js-set-row');

                      sets.forEach((set, index) => {
                        const weightInput = set.querySelector('.js-weight-input');
                        const repsInput = set.querySelector('.js-reps-input');
                        const unitSelect = set.querySelector('.js-unit-select');

                        const weight = parseFloat(weightInput.value) || 0;
                        const reps = parseInt(repsInput.value) || 0;
                        const unit = unitSelect.value;

                        let weightInKg = weight;
                        if (unit === '磅') {
                          weightInKg = parseFloat((weight * LB_TO_KG).toFixed(2));
                        }

                        if (weight > 0 || reps > 0) {
                          workoutData.push({
                            date: dateToSave,
                            motion: exerciseName,
                            set: index + 1,
                            weight: weight,
                            unit: unit,
                            reps: reps,
                            weight_in_kg: weightInKg,
                            note: note // 將備註加入到每一組的資料中
                          });
                        }
                      });
                    });
                    console.log("收集到的訓練資料:", workoutData);
                    return workoutData;
                },

                updateDailyTotalVolume() {
                    const LB_TO_KG = 0.45359237;
                    const allExerciseCards = document.querySelectorAll('#workout-list .card');
                    let dailyTotalVolumeInKg = 0;

                    allExerciseCards.forEach(card => {
                        const sets = card.querySelectorAll('.js-set-row');
                        sets.forEach(set => {
                            const weightInput = set.querySelector('.js-weight-input');
                            const repsInput = set.querySelector('.js-reps-input');
                            const unitSelect = set.querySelector('.js-unit-select');
                            
                            let weight = parseFloat(weightInput.value) || 0;
                            const reps = parseInt(repsInput.value) || 0;
                            const currentUnit = unitSelect.value;

                            if (currentUnit === '磅') {
                                weight = weight * LB_TO_KG;
                            }
                            
                            dailyTotalVolumeInKg += weight * reps;
                        });
                    });

                    const displayElement = document.getElementById('daily-total-volume-display');
                    if (displayElement) {
                        const finalVolume = parseFloat(dailyTotalVolumeInKg.toFixed(2));
                        displayElement.textContent = `${finalVolume} 公斤`;
                    }
                },

                calculateVolume(exerciseCard) {
                    const LB_TO_KG = 0.45359237;
                    const KG_TO_LB = 2.20462262;
                    const sets = exerciseCard.querySelectorAll('.js-set-row');
                    let totalVolumeInKg = 0;
                    let displayUnit = '公斤';

                    if (sets.length > 0) {
                        const firstUnitSelect = sets[0].querySelector('.js-unit-select');
                        if (firstUnitSelect) {
                            displayUnit = firstUnitSelect.value;
                        }
                    }

                    sets.forEach(set => {
                        const weightInput = set.querySelector('.js-weight-input');
                        const repsInput = set.querySelector('.js-reps-input');
                        const unitSelect = set.querySelector('.js-unit-select');
                        
                        let weight = parseFloat(weightInput.value) || 0;
                        const reps = parseInt(repsInput.value) || 0;
                        const currentUnit = unitSelect.value;

                        if (currentUnit === '磅') {
                            weight = weight * LB_TO_KG;
                        }
                        
                        totalVolumeInKg += weight * reps;
                    });

                    let displayVolume = totalVolumeInKg;
                    if (displayUnit === '磅') {
                        displayVolume = totalVolumeInKg * KG_TO_LB;
                    }
                    
                    const displayElement = exerciseCard.querySelector('.js-volume-display');
                    if (displayElement) {
                        const finalVolume = parseFloat(displayVolume.toFixed(2));
                        displayElement.textContent = `${finalVolume} ${displayUnit}`;
                    }
                },
				
                // 輔助函式：專門用來從模板創建一個「組」元素
                createSetElement(setNumber) {
                    const template = document.getElementById('set-row-template');
                    const newSet = document.importNode(template.content, true); // 複製模板
                    
                    // 填入組別編號
                    newSet.querySelector('.js-set-number').textContent = `SET ${setNumber}`;
                    return newSet;
                },
                
                addSet(exerciseCard) {
                    const setsContainer = exerciseCard.querySelector('.js-sets-container');
                    const allSets = setsContainer.querySelectorAll('.js-set-row');
                    const setNumber = allSets.length + 1;

                    // (新功能) 獲取上一組的數據
                    let lastWeight = '';
                    let lastUnit = '公斤';
                    if (allSets.length > 0) {
                        const lastSet = allSets[allSets.length - 1];
                        lastWeight = lastSet.querySelector('.js-weight-input').value;
                        lastUnit = lastSet.querySelector('.js-unit-select').value;
                    }

                    const newSetElement = this.createSetElement(setNumber);
                    newSetElement.firstElementChild.classList.add('animated-item', 'fade-in');
                    
                    // (新功能) 將數據填入新的一組
                    newSetElement.querySelector('.js-weight-input').value = lastWeight;
                    newSetElement.querySelector('.js-unit-select').value = lastUnit;
                    
                    setsContainer.appendChild(newSetElement);
                    const addedSet = setsContainer.querySelector('.js-set-row:last-child');
                    if(addedSet) {
                        setTimeout(() => addedSet.classList.add('is-visible'), 10);
                    }

                    this.calculateVolume(exerciseCard);
                    this.updateDailyTotalVolume();
                    
                    // (新功能) 自動將焦點移至新組的「次數」輸入框，方便快速輸入
                    const newRepsInput = setsContainer.querySelector('.js-set-row:last-child .js-reps-input');
                    if (newRepsInput) {
                        newRepsInput.focus();
                    }
                },

                deleteSet(setRow) {
                    const exerciseCard = setRow.closest('.card');
                    const setsContainer = setRow.parentElement;

                    // 1. 啟動單一組別的刪除動畫
                    app.ui.removeWithAnimation(setRow);

                    // 2. 等待動畫結束後，再執行後續判斷
                    setTimeout(() => {
                        const remainingSets = setsContainer.querySelectorAll('.js-set-row');

                        // ✅ 核心判斷邏輯
                        if (remainingSets.length === 0) {
                            // 如果這是最後一組，就刪除整個動作卡片
                            // 並將更新總容量的函式作為回呼，在卡片刪除後執行
                            app.ui.removeWithAnimation(exerciseCard, app.methods.updateDailyTotalVolume);
                        } else {
                            // 如果還有剩餘組別，就執行原本的重新編號和更新容量
                            remainingSets.forEach((set, index) => {
                                const setNumberSpan = set.querySelector('.js-set-number');
                                if (setNumberSpan) {
                                    setNumberSpan.textContent = `SET ${index + 1}`;
                                }
                            });

                            if (exerciseCard) {
                                app.methods.calculateVolume(exerciseCard);
                            }
                            app.methods.updateDailyTotalVolume();
                        }
                    }, 300); // 這個延遲時間必須與動畫時間一致
                },
                
                handleAddExerciseClick() {
                    app.ui.showAutocompleteModal(true, (exerciseName) => {
                      if (exerciseName && exerciseName.trim() !== '') {
                        app.methods.addExercise(exerciseName.trim());
                        app.ui.showAutocompleteModal(false);
                      } else {
                        app.ui.showToast('請輸入動作名稱！');
                      }
                    });
                },
				
                updateAutocompleteSuggestions(inputValue) {
                    const suggestionsList = document.getElementById('suggestions-list');
                    suggestionsList.innerHTML = ''; // 清空舊的建議
                    const query = inputValue.toLowerCase().trim();

                    if (query.length === 0) {
                      return; // 如果輸入為空，不顯示任何建議
                    }

                    const filteredNames = app.state.cache.exerciseNameList.filter(name => 
                      name.toLowerCase().includes(query)
                    );

                    filteredNames.slice(0, 5).forEach(name => { // 最多顯示 5 筆建議
                      const item = document.createElement('button');
                      item.className = 'w-full text-left p-2 bg-gray-800 hover:bg-gray-700 rounded-md js-suggestion-item';
                      item.textContent = name;
                      suggestionsList.appendChild(item);
                    });
                },
                
                handleSaveAsTemplateClick() {
                    const exerciseCards = document.querySelectorAll('#workout-list .card');
                    if (exerciseCards.length === 0) {
                        app.ui.showToast('日誌中沒有任何動作可以儲存為範本。');
                        return;
                    }
                    app.ui.showPromptModal(true, '另存為範本', '請輸入範本名稱...', (templateName) => {
                        if (templateName) {
                            const exercises = [...exerciseCards].map(card => card.querySelector('h3').textContent);
                            app.ui.showLoading(true);
                            app.api.saveWorkoutTemplate(templateName, exercises)
                                .then(response => {
                                    app.ui.showToast(response.message);
                                    return app.api.getWorkoutTemplates();
                                })
                                .then(templates => {
                                    app.state.cache.workoutTemplates = templates;
                                    app.ui.populateTemplateList(templates);
                                })
                                .catch(err => {
                                    // 【修改】
                                    this.handleError(err, '儲存範本失敗');
                                })
                                .finally(() => { //
                                    app.ui.showPromptModal(false);
                                    app.ui.showLoading(false);
                                });
                        } else {
                            app.ui.showToast('請輸入範本名稱！');
                        }
                    });
                },

                handleLoadTemplate(templateName) {
                    const template = app.state.cache.workoutTemplates[templateName];
                    if (template && confirm('確定要載入範本「' + templateName + '」嗎？這將會覆蓋目前的日誌內容。')) {
                        app.ui.clearWorkoutLog();
                        template.forEach(exercise => app.methods.addExercise(exercise.name));
                        app.ui.showLoadTemplateModal(false);
                    }
                },

                handleDeleteTemplate(templateName) {
                    // 顯示確認對話框
                    app.state.modal.confirmCallback = () => {
                        app.ui.showLoading(true);
                        app.api.deleteWorkoutTemplate(templateName)
                            .then(response => {
                                if (response.status === 'error') throw new Error(response.message);
                                
                                app.ui.showToast(response.message);
                                
                                // 刪除成功後，重新獲取最新的範本列表並更新UI
                                return app.api.getWorkoutTemplates();
                            })
                            .then(templates => {
                                app.state.cache.workoutTemplates = templates;
                                app.ui.populateTemplateList(templates);
                            })
                            .catch(err => {
                                this.handleError(err, '刪除範本失敗');
                            })
                            .finally(() => {
                                app.ui.showLoading(false);
                            });
                    };
                    app.ui.showConfirmDeleteModal(true, `您確定要刪除範本「${templateName}」嗎？此操作無法復原。`);
                },
                
                handleClearWorkoutClick() {
                    const exerciseCards = document.querySelectorAll('#workout-list .card');
                    if (exerciseCards.length === 0) {
                        app.ui.showToast('日誌已經是空的。');
                        return;
                    }
                    app.state.modal.confirmCallback = () => app.ui.clearWorkoutLog();
                    app.ui.showConfirmDeleteModal(true, '您確定要清空所有訓練動作嗎？此操作無法復原。');
                },
                
                addExercise(name) {
                    const workoutList = document.getElementById('workout-list');
                    if (!workoutList) return;
                    
                    // 1. 取得並複製 "動作卡片" 模板
                    const template = document.getElementById('exercise-card-template');
                    const newCardFragment = document.importNode(template.content, true);
                    
                    // 2. 取得卡片根元素並設定動態內容
                    const cardElement = newCardFragment.querySelector('.card');
                    const cardId = 'exercise-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
                    cardElement.id = cardId;
                    cardElement.classList.add('animated-item', 'fade-in');
                    cardElement.querySelector('h3').textContent = name;
                    
                    // 3. 在卡片中新增第一組
                    const setsContainer = cardElement.querySelector('.js-sets-container');
                    const firstSetElement = this.createSetElement(1);
                    setsContainer.appendChild(firstSetElement);

                    // 4. 將完成的卡片加到畫面上
                    workoutList.appendChild(newCardFragment);
                    setTimeout(() => {
                        cardElement.classList.add('is-visible');
                    }, 10);

                    // 5. (邏輯不變) 查詢上次表現
                    const performanceEl = cardElement.querySelector('.js-last-performance');
                    app.api.getLatestPerformance(name, app.state.user.currentUser).then(data => {
                      if (data && data.weight_kg != null && data.reps != null) { // 檢查 weight_kg 和 reps 是否存在
                        //performanceEl.innerHTML = `上次: <span class="font-bold">${data.weight_kg} kg(${data.weight_lbs} lbs) x ${data.reps} 次</span>`;
                        performanceEl.innerHTML = `上次: <span class="font-bold">${data.weight_kg} kg x ${data.reps} 次</span>`;
                      } else {
                        performanceEl.textContent = '無歷史紀錄'; //
                      }
                    }).catch(err => {
                      performanceEl.textContent = '查詢失敗';
                      this.handleError(err, `查詢 ${name} 上次表現失敗`);
                    });

                    this.updateDailyTotalVolume();
                },

                copyLastSet(exerciseCard) {
                    const setsContainer = exerciseCard.querySelector('.js-sets-container');
                    const lastSet = setsContainer.querySelector('.js-set-row:last-child');

                    if (!lastSet) {
                        // 如果連一組都沒有，就執行新增空白組
                        this.addSet(exerciseCard);
                        return;
                    }

                    // 讀取最後一組的數據
                    const lastWeight = lastSet.querySelector('.js-weight-input').value;
                    const lastReps = lastSet.querySelector('.js-reps-input').value;
                    const lastUnit = lastSet.querySelector('.js-unit-select').value;
                    
                    // 先新增一個空白組
                    this.addSet(exerciseCard);
                    
                    // 找到剛剛新增的那一組 (現在的最後一組)
                    const newSet = setsContainer.querySelector('.js-set-row:last-child');
                    if (newSet) {
                        // 將上一組的數據填入
                        newSet.querySelector('.js-weight-input').value = lastWeight;
                        newSet.querySelector('.js-reps-input').value = lastReps;
                        newSet.querySelector('.js-unit-select').value = lastUnit;
                    }
                    
                    // 更新總容量計算
                    this.calculateVolume(exerciseCard);
                    this.updateDailyTotalVolume();
                },

                deleteExercise(exerciseCard) {
                    const exerciseName = exerciseCard.querySelector('h3').textContent;
                    app.state.modal.elementToDelete = exerciseCard;
                    app.state.modal.confirmCallback = () => {
                        if(app.state.modal.elementToDelete) {
                            app.ui.removeWithAnimation(app.state.modal.elementToDelete, app.methods.updateDailyTotalVolume);
                        }
                    };
                    app.ui.showConfirmDeleteModal(true, '您確定要刪除「' + exerciseName + '」這個動作嗎？');
                },
				
                // 格式化秒數為 mm:ss
                formatTime(seconds) {
                    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const secs = (seconds % 60).toString().padStart(2, '0');
                    return `${mins}:${secs}`;
                },

                // 更新計時器顯示
                updateTimerDisplay() {
                    const timerDisplay = document.getElementById('timer-display');
                    if (timerDisplay) {
                        timerDisplay.textContent = this.formatTime(app.state.timer.secondsLeft); // 🆕
                    }
                },

                // 開始計時
                startTimer(seconds) {
                    if (app.state.timer.interval) { // 🆕
                        clearInterval(app.state.timer.interval); // 🆕
                    }
                    app.state.timer.secondsLeft = seconds; // 🆕
                    this.updateTimerDisplay();

                    const timerBar = document.getElementById('rest-timer-bar');
                    timerBar.classList.remove('hidden');

                    app.state.timer.interval = setInterval(() => { // 🆕
                        app.state.timer.secondsLeft--; // 🆕
                        this.updateTimerDisplay();
                        if (app.state.timer.secondsLeft <= 0) { // 🆕
                            this.resetTimer();
                            alert('休息結束！');
                        }
                    }, 1000);
                },

                // 增加或減少時間
                addTimerTime(seconds) {
                    if(app.state.timer.interval) { // 🆕
                        app.state.timer.secondsLeft += seconds; // 🆕
                        if(app.state.timer.secondsLeft < 0) app.state.timer.secondsLeft = 0; // 🆕
                        this.updateTimerDisplay();
                    }
                },

                // 重置並隱藏計時器
                resetTimer() {
                    if (app.state.timer.interval) { // 🆕
                        clearInterval(app.state.timer.interval); // 🆕
                        app.state.timer.interval = null; // 🆕
                    }
                    const timerBar = document.getElementById('rest-timer-bar');
                    timerBar.classList.add('hidden');
                },

                async handleOpenCompareModal() {
                    app.ui.showCompareModal(true);
                    // 如果從未載入過歷史資料，就去後端讀取一次
                    if (app.state.cache.photoHistory.length === 0 || app.state.cache.photoHistory.currentUser !== app.state.user.currentUser) {
                        try {
                            app.ui.showLoading(true);
                            const records = await app.api.getAllPhotoRecords(app.state.user.currentUser);
                            if (records.error) throw new Error(records.error);

                            app.state.cache.photoHistory = records; // 將資料存起來
                            app.state.cache.photoHistory.currentUser = app.state.user.currentUser;

                            // 填充下拉選單
                            const selectBefore = document.getElementById('compare-select-before');
                            const selectAfter = document.getElementById('compare-select-after');
                            selectBefore.innerHTML = '<option value="">選擇對比日期 (之前)</option>';
                            selectAfter.innerHTML = '<option value="">選擇對比日期 (之後)</option>';

                            records.forEach(record => {
                                const date = new Date(record.date).toLocaleDateString();
                                const option = `<option value="${record.date}">${date}</option>`;
                                selectBefore.innerHTML += option;
                                selectAfter.innerHTML += option;
                            });
                        } catch (e) {
                            this.handleError(e, '無法載入照片歷史紀錄');
                        } finally {
                            app.ui.showLoading(false);
                        }
                    } else {
                        console.log(`Using cached photo history for ${app.state.user.currentUser}.`);
                        // 如果快取有效，也需要重新填充下拉選單 (因為 modal 可能被重用了)
                        const selectBefore = document.getElementById('compare-select-before');
                        const selectAfter = document.getElementById('compare-select-after');
                        selectBefore.innerHTML = '<option value="">選擇對比日期 (之前)</option>';
                        selectAfter.innerHTML = '<option value="">選擇對比日期 (之後)</option>';
                        app.state.cache.photoHistory.forEach(record => {
                            const date = new Date(record.date).toLocaleDateString();
                            const option = `<option value="${record.date}">${date}</option>`;
                            selectBefore.innerHTML += option;
                            selectAfter.innerHTML += option;
                        });
                    }
                },

                // 當下拉選單變更時，更新對應的圖片
                updateCompareImage(position, dateISO) { // position is 'before' or 'after'
                    const record = app.state.cache.photoHistory.find(r => r.date === dateISO);

                    const types = ['front', 'side', 'back'];
                    types.forEach(type => {
                        const container = document.getElementById(`compare-${type}-${position}`);
                        if (!record) { // 如果是選擇 "請選擇..."
                            container.innerHTML = `<span class="text-gray-500">${type === 'front' ? '正面' : (type === 'side' ? '側面' : '背面')}</span>`;
                            return;
                        }

                        const photoId = record[`photo_${type}_id`];
                        if (photoId) {
                            const thumbnailUrl = 'https://drive.google.com/thumbnail?id=' + photoId;
                            // ⭐ 修改：使用新的 URL 格式來獲取高解析度圖片
                            const highResUrl = `https://lh3.googleusercontent.com/d/${photoId}`;

                            container.innerHTML = `<img src="${thumbnailUrl}" data-fullsize-url="${highResUrl}" class="w-full h-full object-cover rounded cursor-pointer" alt="歷史照片對比">`;
                        } else {
                            container.innerHTML = '<span class="text-gray-500">無照片</span>';
                        }
                    });
                },

                async loadPRData() {
                    // 🆕 使用快取管理系統檢查
                    if (app.cache.isValid(app.cache.keys.PR_DATA, app.state.user.currentUser)) {
                        console.log(`使用 ${app.state.user.currentUser} 的快取 PR 資料`);
                        app.ui.showPRsState(app.state.cache.prData.bests.length > 0 || app.state.cache.prData.repPRs.length > 0 ? 'content' : 'empty');
                        this.renderPRs(app.state.cache.prData);
                        return;
                    }

                    app.ui.showPRsState('loading');
                    try {
                        console.log(`為 ${app.state.user.currentUser} 重新載入 PR 資料...`);
                        const data = await app.api.getAllPRs(app.state.user.currentUser);
                        if (data.error) throw new Error(data.error);

                        app.state.cache.prData = data;
                        app.state.cache.prData.currentUser = app.state.user.currentUser;

                        const hasData = data.bests.length > 0 || data.repPRs.length > 0;
                        if (hasData) {
                            this.renderPRs(data);
                            app.ui.showPRsState('content');
                        } else {
                            app.ui.showPRsState('empty');
                        }
                    } catch (e) {
                        this.handleError(e, '無法載入個人紀錄');
                        app.ui.showPRsState('empty');
                    }
                },

                // 將 PR 資料渲染成 HTML 並顯示在頁面上
                renderPRs(data) {
                    const bestsContainer = document.getElementById('bests-container');
                    const repPRsContainer = document.getElementById('rep-prs-container');
                    if (!bestsContainer || !repPRsContainer) return;

                    bestsContainer.innerHTML = '';
                    repPRsContainer.innerHTML = '';

                    const todayString = new Date().toDateString();
                    const categoryOrder = ['胸', '肩', '背', '臀', '腿', '手', '其他'];

                    // 渲染 Bests 區塊
                    const groupedBests = data.bests.reduce((acc, b) => {
                        if (!acc[b.category]) acc[b.category] = [];
                        acc[b.category].push(b);
                        return acc;
                    }, {});

                    categoryOrder.forEach(category => {
                        const titleEl = document.createElement('h4');
                        titleEl.className = 'text-xl font-semibold text-yellow-400 mt-6 mb-3 category-title';
                        titleEl.textContent = category;
                        bestsContainer.appendChild(titleEl);

                        const itemsContainer = document.createElement('div');
                        itemsContainer.className = 'space-y-3 pr-sortable-container';
                        itemsContainer.dataset.category = category;

                        if (groupedBests[category] && groupedBests[category].length > 0) {
                            groupedBests[category].forEach(b => {
                                const isNewPR = (b.heaviestDateISO && new Date(b.heaviestDateISO).toDateString() === todayString) || (b.e1rmDateISO && new Date(b.e1rmDateISO).toDateString() === todayString);
                                const itemHtml = `
                                <div class="card p-3 rounded-md pr-card ${isNewPR ? 'is-new-pr' : ''}" data-motion="${b.motion}">
                                    ${isNewPR ? '<ion-icon name="ribbon-outline" class="new-pr-crown"></ion-icon><span class="new-pr-badge">NEW!</span>' : ''}
                                    <div class="flex items-center gap-2 pointer-events-none">
                                        <ion-icon name="menu-outline" class="js-pr-drag-handle hidden text-2xl text-gray-500 cursor-grab pointer-events-auto"></ion-icon>
                                        <p class="font-semibold text-base text-yellow-400">${b.motion}</p>
                                    </div>
                                    <div class="flex justify-between items-center text-sm mt-1 pointer-events-none">
                                        <span class="text-gray-400">最重重量:</span><span class="font-bold text-white">${b.heaviestWeight} kg <span class="text-xs text-gray-500">(${b.heaviestDate})</span></span>
                                    </div>
                                    <div class="flex justify-between items-center text-sm mt-1 pointer-events-none">
                                        <span class="text-gray-400">最高 E1RM:</span><span class="font-bold text-white">${b.bestEst1RM} kg <span class="text-xs text-gray-500">(${b.e1rmDate})</span></span>
                                    </div>
                                </div>`;
                                itemsContainer.innerHTML += itemHtml;
                            });
                        } else {
                            itemsContainer.innerHTML = '<p class="text-gray-500 text-sm pl-4 pr-placeholder">尚無 Bests 紀錄。</p>';
                        }
                        bestsContainer.appendChild(itemsContainer);
                    });

                    // 渲染 Rep PRs 區塊
                    const groupedRepPRs = data.repPRs.reduce((acc, pr) => {
                        if (!acc[pr.category]) acc[pr.category] = {};
                        if (!acc[pr.category][pr.motion]) acc[pr.category][pr.motion] = [];
                        acc[pr.category][pr.motion].push(pr);
                        return acc;
                    }, {});

                    categoryOrder.forEach(category => {
                        const titleEl = document.createElement('h4');
                        titleEl.className = 'text-xl font-semibold text-yellow-400 mt-8 mb-3 category-title';
                        titleEl.textContent = category;
                        repPRsContainer.appendChild(titleEl);

                        const motionContainer = document.createElement('div');
                        motionContainer.className = 'space-y-4 pr-sortable-container';
                        motionContainer.dataset.category = category;

                        if (groupedRepPRs[category] && Object.keys(groupedRepPRs[category]).length > 0) {
                            for (const motion in groupedRepPRs[category]) {
                                const prsForMotion = groupedRepPRs[category][motion];
                                prsForMotion.sort((a, b) => a.rmCategory - b.rmCategory);
                                const hasNewPRInGroup = prsForMotion.some(pr => pr.dateISO && (new Date(pr.dateISO).toDateString() === todayString));

                                let motionHtml = `<div class="card p-3 rounded-md pr-card ${hasNewPRInGroup ? 'is-new-pr' : ''}" data-motion="${motion}">
                                                      ${hasNewPRInGroup ? '<ion-icon name="ribbon-outline" class="new-pr-crown"></ion-icon><span class="new-pr-badge">NEW!</span>' : ''}
                                                      <div class="flex items-center gap-2 pointer-events-none mb-2">
                                                          <ion-icon name="menu-outline" class="js-pr-drag-handle hidden text-2xl text-gray-500 cursor-grab pointer-events-auto"></ion-icon>
                                                          <p class="font-semibold text-base text-white">${motion}</p>
                                                      </div>
                                                      <div class="space-y-1 pointer-events-none">`;
                                prsForMotion.forEach(pr => {
                                    motionHtml += `<div class="flex justify-between items-center text-sm bg-black/30 p-1 rounded">
                                                        <span class="text-yellow-400 w-16">${pr.rmCategory}RM</span><span class="text-white flex-grow">${pr.weight} kg</span><span class="text-xs text-gray-500">${pr.date}</span>
                                                    </div>`;
                                });
                                motionHtml += '</div></div>';
                                motionContainer.innerHTML += motionHtml;
                            }
                        } else {
                            motionContainer.innerHTML = '<p class="text-gray-500 text-sm pl-4 pr-placeholder">尚無 Rep PRs 紀錄。</p>';
                        }
                        repPRsContainer.appendChild(motionContainer);
                    });

                    // 渲染完成後，立即初始化拖曳功能
                    this.initPRsDragAndDrop();
                },

                initPRsDragAndDrop() {
                    const containers = document.querySelectorAll('.pr-sortable-container');
                    if (containers.length === 0) return;

                    const placeholderHtml = {
                        bests: '<p class="text-gray-500 text-sm pl-4 pr-placeholder">尚無 Bests 紀錄。</p>',
                        repPRs: '<p class="text-gray-500 text-sm pl-4 pr-placeholder">尚無 Rep PRs 紀錄。</p>'
                    };

                    containers.forEach(container => {
                        new Sortable(container, {
                            group: 'sharedPRs',
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            chosenClass: 'sortable-chosen',
                            disabled: !app.state.ui.isPREditMode,
                            handle: '.js-pr-drag-handle',
                            delay: 50,
                            delayOnTouchOnly: true,

                            onAdd: function(evt) {
                                const motion = evt.item.dataset.motion;
                                const newCategory = evt.to.dataset.category;
                                
                                const placeholder = evt.to.querySelector('.pr-placeholder');
                                if (placeholder) placeholder.remove();

                                app.state.pr.categoryChanges.set(motion, newCategory);
                                app.methods.syncPRCardCategory(motion, newCategory, evt.item);
                            },

                            onRemove: function(evt) {
                                if (evt.from.querySelectorAll('.pr-card').length === 0) {
                                    const containerType = evt.from.closest('#bests-container') ? 'bests' : 'repPRs';
                                    evt.from.innerHTML = placeholderHtml[containerType];
                                }
                            }
                        });
                    });
                },

                syncPRCardCategory(motion, newCategory, draggedItem) {
                    const isBestsCard = draggedItem.closest('#bests-container');
                    
                    const selector = isBestsCard 
                        ? `#rep-prs-container .pr-card[data-motion="${motion}"]`
                        : `#bests-container .pr-card[data-motion="${motion}"]`;
                    const cardToSync = document.querySelector(selector);

                    if (cardToSync) {
                        const oldContainer = cardToSync.parentElement;
                        const newContainerSelector = isBestsCard
                            ? `#rep-prs-container .pr-sortable-container[data-category="${newCategory}"]`
                            : `#bests-container .pr-sortable-container[data-category="${newCategory}"]`;
                        const newContainer = document.querySelector(newContainerSelector);
                        
                        if (newContainer && oldContainer !== newContainer) {
                            const placeholderInNew = newContainer.querySelector('.pr-placeholder');
                            if (placeholderInNew) placeholderInNew.remove();
                            
                            newContainer.appendChild(cardToSync);

                            if (oldContainer.querySelectorAll('.pr-card').length === 0) {
                                const containerType = isBestsCard ? 'repPRs' : 'bests';
                                oldContainer.innerHTML = (containerType === 'bests')
                                    ? '<p class="text-gray-500 text-sm pl-4 pr-placeholder">尚無 Bests 紀錄。</p>'
                                    : '<p class="text-gray-500 text-sm pl-4 pr-placeholder">尚無 Rep PRs 紀錄。</p>';
                            }
                        }
                    }
                },
                
                togglePREditMode(isEditing) {
                    app.state.ui.isPREditMode = isEditing;
                    
                    document.getElementById('edit-prs-btn').classList.toggle('hidden', isEditing);
                    document.getElementById('prs-edit-actions').classList.toggle('hidden', !isEditing);
                    
                    document.querySelectorAll('.pr-sortable-container').forEach(container => {
                        const sortableInstance = Sortable.get(container);
                        if (sortableInstance) {
                            sortableInstance.option('disabled', !isEditing);
                        }
                    });

                    document.querySelectorAll('.pr-card').forEach(card => {
                        card.classList.toggle('is-editable', isEditing);
                    });

                    document.querySelectorAll('.js-pr-drag-handle').forEach(handle => handle.classList.toggle('hidden', !isEditing));

                    if (!isEditing) {
                        app.state.pr.categoryChanges.clear();
                        // ⭐️ 修正取消邏輯：清除快取再重新載入
                        app.state.cache.prData = null; 
                        app.methods.loadPRData();
                    }
                },

                handleSavePRCategories() {
                    if (app.state.pr.categoryChanges.size === 0) {
                        app.ui.showToast('沒有任何分類變更需要儲存。');
                        this.togglePREditMode(false);
                        return;
                    }

                    app.ui.showLoading(true);

                    const changesArray = Array.from(app.state.pr.categoryChanges, ([motion, category]) => ({ motion, category }));

                    app.api.updateMultipleExerciseCategories(changesArray)
                        .then(response => {
                            if (response.status === 'success') {
                                app.ui.showToast(response.message);
                                app.state.pr.categoryChanges.clear();
                                app.state.cache.prData = null; // 清除快取
                                this.togglePREditMode(false);
                                app.methods.loadPRData();
                            } else {
                                throw new Error(response.message);
                            }
                        })
                        .catch(err => {
                            this.handleError(err, '儲存分類變更失敗');
                        })
                        .finally(() => {
                            app.ui.showLoading(false);
                        });
                },

                // ⭐ [新增] 當點擊 "新增/編輯建議" 按鈕時的處理函式
                handleAdminCommentClick(button) {
                    const { date, motion, currentComment } = button.dataset;
                    app.ui.showPromptModal(true, `給「${motion}」的建議`, '請輸入您的指導建議...', (newComment) => {
                        // 使用者按下確認後，呼叫儲存函式
                        if (newComment !== null) { // 允許儲存空字串來刪除留言
                            app.methods.handleSaveAdminComment(date, motion, newComment);
                        }
                    });
                    // 預先將目前的留言填入輸入框，方便編輯
                    const promptInput = document.getElementById('prompt-input');
                    if(promptInput) {
                        promptInput.value = currentComment;
                    }
                },

                // ⭐ [新增] 處理儲存管理員建議的函式
                handleSaveAdminComment(date, motion, comment) {
                    app.ui.showLoading(true);
                    app.api.saveAdminComment(app.state.user.currentUser, date, motion, comment)
                        .then(response => {
                            if (response.status === 'error') throw new Error(response.message);
                            app.ui.showToast(response.message);

                            const progressDataForMotion = app.state.cache.analysisData?.singleExerciseProgress?.[motion];
                            if (progressDataForMotion) {
                                
                                // ⭐ [關鍵修正] 在比較前，將 dp.x (ISO 字串) 也轉換成 'yyyy-MM-dd' 格式
                                const dataPointToUpdate = progressDataForMotion.find(dp => new Date(dp.x).toLocaleDateString('sv') === date);

                                if (dataPointToUpdate) {
                                    dataPointToUpdate.adminNote = comment;
                                    console.log('前端狀態已即時更新:', motion, date);
                                } else {
                                    // 這個警告現在應該不會再出現了
                                    console.warn('在前端狀態中找不到要更新的資料點:', date);
                                }
                            } else {
                                console.warn('在前端狀態中找不到對應的動作:', motion);
                            }

                            // 只重新渲染受影響的圖表和備註區
                            app.methods._renderExerciseProgressChart(motion, app.state.cache.analysisData.singleExerciseProgress);

                            const selectEl = document.getElementById('exercise-progress-select');
                            if (selectEl) {
                                selectEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                            
                        })
                        .catch(err => {
                            this.handleError(err, '儲存指導建議失敗');
                        })
                        .finally(() => {
                            app.ui.showPromptModal(false);
                            app.ui.showLoading(false);
                        });
                }
            },

            // UI 相關函式
            ui: {
                renderPage() {
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    const newPage = document.getElementById('page-' + app.state.ui.currentView);
                    if(newPage) newPage.classList.add('active');
                },
                showLoading(isLoading) {
                    const overlay = document.getElementById('loading-overlay');
                    if (overlay) {
                        overlay.style.display = isLoading ? 'flex' : 'none';
                    }
                },
                showAdminBar(show) {
                    const bar = document.getElementById('admin-bar');
                    if(bar) bar.style.display = show ? 'block' : 'none';
                },
                showReminderBanner(show) {
                    const banner = document.getElementById('reminder-banner');
                    if(banner) banner.style.display = show ? 'block' : 'none';
                },
                showPromptModal(show, title = '', placeholder = '', callback = null) {
                    const modal = document.getElementById('prompt-modal');
                    if (show) {
                        document.getElementById('prompt-title').textContent = title;
                        const input = document.getElementById('prompt-input');
                        input.placeholder = placeholder;
                        input.value = '';
                        app.state.modal.promptCallback = callback; // 🆕
                        modal.classList.remove('hidden');
                        input.focus();
                    } else {
                        modal.classList.add('hidden');
                        app.state.modal.promptCallback = null; // 🆕
                    }
                },
                
                showAutocompleteModal(show, callback = null) {
                    const modal = document.getElementById('autocomplete-modal');
                    if (modal) {
                      if (show) {
                        const input = document.getElementById('autocomplete-input');
                        input.value = ''; // 清空輸入框
                        document.getElementById('suggestions-list').innerHTML = ''; // 清空建議
                        app.state.modal.promptCallback = callback;
                        modal.classList.remove('hidden');
                        input.focus();
                      } else {
                        modal.classList.add('hidden');
                        app.state.modal.promptCallback = null;
                      }
                    }
                },
				
                showLoadTemplateModal(show) {
                    const modal = document.getElementById('load-template-modal');
                    if(modal) modal.classList.toggle('hidden', !show);
                },

                populateTemplateList(templates) {
                    const container = document.getElementById('template-list');
                    if(!container) return;
                    container.innerHTML = '';
                    if (Object.keys(templates).length === 0) {
                        container.innerHTML = '<p class="text-gray-400 text-center">尚未建立任何範本。</p>';
                        return;
                    }
                    for (const templateName in templates) {
                        // 建立一個容器來包裹載入按鈕和刪除按鈕
                        const itemContainer = document.createElement('div');
                        itemContainer.className = "flex items-center justify-between gap-2 bg-gray-800 rounded-md";

                        // 原始的載入按鈕
                        const btn = document.createElement('button');
                        btn.className = "flex-grow text-left p-3 hover:bg-gray-700 rounded-l-md js-load-template";
                        btn.textContent = templateName;
                        btn.dataset.templateName = templateName;

                        // 新增的刪除按鈕
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = "p-3 text-gray-500 hover:text-red-500 js-delete-template";
                        deleteBtn.dataset.templateName = templateName;
                        // 使用 ionicons 的 "close-circle" 圖示
                        deleteBtn.innerHTML = '<ion-icon name="close-circle-outline" class="text-xl pointer-events-none"></ion-icon>';

                        itemContainer.appendChild(btn);
                        itemContainer.appendChild(deleteBtn);
                        container.appendChild(itemContainer);
                    }
                },

                clearWorkoutLog() {
                    const workoutList = document.getElementById('workout-list');
                    if(workoutList) {
                        workoutList.innerHTML = '';
                        app.methods.updateDailyTotalVolume();
                    }
                },
                showConfirmDeleteModal(show, message = '您確定要刪除嗎？') {
                    const modal = document.getElementById('confirm-delete-modal');
                    if (modal) {
                         if (show) {
                            modal.querySelector('#delete-confirm-message').textContent = message;
                            modal.classList.remove('hidden');
                        } else {
                            modal.classList.add('hidden');
                            app.state.modal.elementToDelete = null; // Clean up
                            app.state.modal.confirmCallback = null;
                        }
                    }
                },
                showHistoryState(state) {
                    const loading = document.getElementById('history-loading');
                    const content = document.getElementById('history-content');
                    const empty = document.getElementById('history-empty');
                    if(loading) loading.style.display = state === 'loading' ? 'block' : 'none';
                    if(content) content.style.display = state === 'content' ? 'block' : 'none';
                    if(empty) empty.style.display = state === 'empty' ? 'block' : 'none';
                },
                populateUserSwitcher(users) {
                    const switcher = document.getElementById('user-switcher');
                    if(!switcher) return;
                    switcher.innerHTML = ''; // 清空
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.email;
                        option.textContent = user.name;
                        switcher.appendChild(option);
                    });
                },
                updateWelcomeMessage(name) {
                    const welcomeEl = document.getElementById('welcome-message');
                    if(welcomeEl) {
                        const welcomeText = (name) ? name : '';
                        welcomeEl.textContent = '歡迎回來\t' + welcomeText;
                    }
                },
                setActiveNav(page) {
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('text-yellow-400');
                        item.classList.add('text-gray-400', 'hover:bg-gray-700/50');
                    });
                    const activeItem = document.querySelector(`.nav-item[onclick="app.navigateTo('${page}')"]`);
                    if(activeItem) {
                        activeItem.classList.add('text-yellow-400');
                        activeItem.classList.remove('text-gray-400', 'hover:bg-gray-700/50');
                    }
                },
                
                populateProfileData(profileData) {
                    if (!profileData) return;
                    document.querySelectorAll('#profile-section .card').forEach(card => {
                        card.querySelectorAll('.edit-mode, .profile-input').forEach(editEl => {
                            const key = editEl.dataset.key;
                            if (!key) return;

                            const value = profileData[key];

                            let viewEl = null;
                            const parentGrid = editEl.closest('.grid');
                            const placeholder = editEl.placeholder;

                            if (placeholder && parentGrid) {
                                viewEl = [...parentGrid.querySelectorAll('.view-mode')].find(v => v.dataset.placeholder && v.dataset.placeholder.startsWith(placeholder));
                            } else {
                                viewEl = editEl.previousElementSibling;
                            }

                            if (viewEl && viewEl.classList.contains('view-mode')) {
                                const hasValue = value !== undefined && value !== null && String(value).trim() !== '';

                                if (editEl.tagName === 'SELECT') {
                                    const matchingOption = hasValue ? [...editEl.options].find(opt => opt.value == value) : null;
                                    viewEl.textContent = matchingOption ? matchingOption.text : viewEl.dataset.placeholder;
                                } else {
                                    if (placeholder && parentGrid) {
                                        viewEl.textContent = hasValue ? (placeholder + ': ' + value) : viewEl.dataset.placeholder;
                                    } else {
                                        viewEl.textContent = hasValue ? value : viewEl.dataset.placeholder;
                                    }
                                }
                            }
                        });
                    });
                },

                populateLatestPhotos(photoData) {
                    const dateEl = document.getElementById('prev-photo-date');
                    const containers = {
                        front: document.getElementById('prev-photo-front-container'),
                        side: document.getElementById('prev-photo-side-container'),
                        back: document.getElementById('prev-photo-back-container')
                    };

                    if(!dateEl || !containers.front || !containers.side || !containers.back) return;
                    
                    if (!photoData || (!photoData.photo_front_id && !photoData.photo_side_id && !photoData.photo_back_id)) {
                        dateEl.textContent = 'N/A';
                        Object.values(containers).forEach(c => c.innerHTML = '<span class="text-gray-500">尚無記錄</span>');
                        return;
                    }

                    dateEl.textContent = new Date(photoData.date).toLocaleDateString();

                    for (const type in containers) {
                        const container = containers[type];
                        const photoId = photoData[`photo_${type}_id`];
                        
                        if (photoId) {
                            const thumbnailUrl = 'https://drive.google.com/thumbnail?id=' + photoId;
                            // ⭐ 修改：使用新的 URL 格式來獲取高解析度圖片
                            const highResUrl = `https://lh3.googleusercontent.com/d/${photoId}`;

                            container.innerHTML = `<img src="${thumbnailUrl}" data-fullsize-url="${highResUrl}" class="w-full h-full object-cover rounded cursor-pointer" alt="前一次${type}照片">`;
                        } else {
                            container.innerHTML = '<span class="text-gray-500">無照片</span>';
                        }
                    }
                },

                removeWithAnimation(element, callback) {
                    if (!element) return;
                    element.classList.remove('is-visible');
                    setTimeout(() => {
                        element.remove();
                        if (callback) {
                            callback();
                        }
                    }, APP_CONSTANTS.UI.ANIMATION_DURATION); // 🆕 使用常數
                },

                showToast(message, type = 'success', duration = APP_CONSTANTS.UI.TOAST_DURATION) {
                    const toast = document.getElementById('toast-notification');
                    const messageEl = document.getElementById('toast-message');
                    if (!toast || !messageEl) return;

                    // 🆕 清除上一個計時器
                    if (app.state.timer.toastTimer) {
                        clearTimeout(app.state.timer.toastTimer);
                    }

                    messageEl.innerHTML = message;
                    toast.classList.remove('bg-yellow-500', 'bg-red-600');
                    if (type === 'success') {
                        toast.classList.add('bg-yellow-500');
                    } else if (type === 'error') {
                        toast.classList.add('bg-red-600');
                    }

                    toast.classList.remove('hidden', 'toast-out');
                    toast.classList.add('toast-in');

                    // 🆕 設定新的計時器
                    app.state.timer.toastTimer = setTimeout(() => {
                        toast.classList.remove('toast-in');
                        toast.classList.add('toast-out');
                        setTimeout(() => {
                            toast.classList.add('hidden');
                        }, 500);
                    }, duration);
                },

                showCompareModal(show) {
                    const modal = document.getElementById('compare-photos-modal');
                    if(modal) modal.classList.toggle('hidden', !show);
                },

                showPRsState(state) { // state can be 'loading', 'content', or 'empty'
                    const loading = document.getElementById('prs-loading');
                    const content = document.getElementById('prs-content');
                    const empty = document.getElementById('prs-empty');
                    if(loading) loading.style.display = state === 'loading' ? 'block' : 'none';
                    if(content) content.style.display = state === 'content' ? 'block' : 'none';
                    if(empty) empty.style.display = state === 'empty' ? 'block' : 'none';
                },

                openImageModal(imageUrl) {
                    const modal = document.getElementById('image-modal');
                    const img = document.getElementById('modal-image');
                    if (modal && img) {
                        img.src = imageUrl;
                        modal.classList.remove('hidden');
                    }
                },

                closeImageModal() {
                    const modal = document.getElementById('image-modal');
                    const img = document.getElementById('modal-image');
                    if (modal && img) {
                        modal.classList.add('hidden');
                        img.src = ''; // 清空 src 避免佔用記憶體
                    }
                }
            },

            // 後端 API 呼叫
            api: {
                    getInitialData(userEmail = null) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getInitialData(userEmail);
                        });
                    },
                    getLatestPerformance(exerciseName, userEmail = null) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getLatestPerformance(exerciseName, userEmail);
                        });
                    },
                    getUniqueExerciseNames(userEmail = null) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getUniqueExerciseNames(userEmail);
                        });
                    },
                    getAnalysisData(userEmail = null) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getAnalysisData(userEmail);
                        });
                    },
                    saveBodyPhotos(data) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .saveBodyPhotosToServer(data);
                        });
                    },
                    saveProfileData(cardId, data) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .saveProfileDataToServer(cardId, data);
                        });
                    },
                    saveWorkoutData(data) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .saveWorkoutDataToServer(data);
                        });
                    },
                    saveWorkoutTemplate(templateName, exercises) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .saveWorkoutTemplateToServer(templateName, exercises);
                        });
                    },
                    getWorkoutTemplates(userEmail = null) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getWorkoutTemplates(userEmail);
                        });
                    },
                    deleteWorkoutTemplate(templateName) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .deleteWorkoutTemplateToServer(templateName);
                        });
                    },
                    processWorkoutForPRs(workoutData) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .processWorkoutForPRs(workoutData);
                        });
                    },
                    getAllPhotoRecords(userEmail = null) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getAllPhotoRecords(userEmail);
                        });
                    },

                    getAllPRs(userEmail = null) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getAllPRs(userEmail);
                        });
                    },

                    updateMultipleExerciseCategories(changesArray) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .updateMultipleExerciseCategoriesToServer(changesArray);
                        });
                    },

                    saveAdminComment(userEmail, date, motion, comment) {
                        return new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .saveAdminCommentToServer(userEmail, date, motion, comment);
                        });
                    }
              },
        };

        Chart.register(ChartDataLabels);

        // 當 DOM 載入完成後，啟動 App
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
	
	
    <template id="exercise-card-template">
          <div class="card p-4 rounded-lg">
              <div class="flex justify-between items-center border-b border-yellow-500/30 pb-2 mb-3">
                  <div class="flex items-center gap-2">
                      <ion-icon name="menu-outline" class="js-drag-handle text-2xl text-gray-500 cursor-grab"></ion-icon>
                      <h3 class="text-lg font-semibold text-yellow-400"></h3>
                  </div>
                  <button class="js-delete-exercise p-1 text-red-500 hover:text-red-400 transition-colors duration-200">
                      <ion-icon name="close-circle-outline" class="text-2xl pointer-events-none"></ion-icon>
                  </button>
              </div>
              
              <p class="text-sm text-yellow-300/80 mb-2 js-last-performance">查詢中...</p>
              
              <div class="flex justify-end items-baseline space-x-2 -mt-2 mb-2">
                  <span class="text-xs text-gray-400">總容量:</span>
                  <p class="text-xl font-bold text-white js-volume-display">0 公斤</p>
              </div>

              <div class="space-y-2 mt-2 js-sets-container">
                  </div>
        
        <div class="mt-3">
          <textarea class="js-exercise-note w-full rounded-md p-2 text-sm" rows="2" placeholder="為這個動作新增備註..."></textarea>
        </div>        
              <div class="grid grid-cols-3 gap-2 mt-3">                  
                  <button class="w-full text-sm bg-yellow-600/80 hover:bg-yellow-500/80 border border-yellow-700 rounded-md p-1 js-start-timer">開始休息</button>
                  <button class="w-full text-sm bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-md p-1 js-copy-set">複製上一組</button>
                  <button class="w-full text-sm bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-md p-1 js-add-set">+ 新增組數</button>
              </div>
          </div>
      </template>

      <template id="set-row-template">
          <div class="flex items-center space-x-2 js-set-row relative">
              <span class="js-pr-badge hidden absolute -left-1 -top-1 bg-yellow-400 text-black text-xs font-bold px-2 py-0.5 rounded-full shadow-md animate-pulse"></span>              
              <span class="js-set-number w-12 text-center text-gray-400 text-sm flex-shrink-0"></span>
              <div class="flex-grow grid grid-cols-2 gap-x-2">
                  <div class="flex items-center space-x-2">
                      <input type="number" min="0" class="w-full rounded-md p-2 text-center js-weight-input">
                      <select class="rounded-md p-2 bg-black border border-yellow-500 text-sm appearance-none text-center js-unit-select">
                          <option>公斤</option>
                          <option>磅</option>
                      </select>
                  </div>
                  <div class="flex items-center space-x-2">
                      <input type="number" min="0" class="w-full rounded-md p-2 text-center js-reps-input">
                      <span class="text-gray-400 text-lg">次</span>
                  </div>
              </div>
              <button class="js-delete-set p-1 text-gray-500 hover:text-red-500 transition-colors duration-200">
                  <ion-icon name="trash-outline" class="text-xl pointer-events-none"></ion-icon>
              </button>
          </div>
      </template>


</body>
</html>